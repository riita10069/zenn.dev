# 3.5 ストレージ階層設計（ホット／ウォーム／コールド）

この節では、大規模な自動運転ログを格納するストレージ階層設計について解説します。オブジェクトストレージ・分散ファイルシステム・テープアーカイブなどを組み合わせたホット／ウォーム／コールド階層、コスト最適化とライフサイクルポリシーの考え方を整理します。データ中心・Closed-Loop の観点から、必要なデータに必要なタイミングでアクセスできることと、長期保管コストのバランスをどのように取るかを考えます。

## ホット／ウォーム／コールド階層

典型的には、以下のような階層構成を取ることが多いです。

- ホットストレージ (hot storage): 頻繁にアクセスされる最新データや実験中データを格納する層で、高速アクセスが可能なオブジェクトストレージや分散ファイルシステムを用います。
- ウォームストレージ (warm storage): 過去のデータでありつつ、まだ比較的アクセス頻度が高いデータを格納する層です。コスト重視のストレージクラスや圧縮率を高めたフォーマットを用いることが多いです。
- コールドストレージ (cold storage): 規制対応や将来の再解析のために長期保管が必要なデータを格納する層で、テープアーカイブや低頻度アクセス向けストレージクラスを用います。

Closed-Loop の観点では、例えば「直近数週間のデータはホット」「過去半年はウォーム」「それより前はコールド」といったポリシーを定め、オンラインモニタリングやモデル改善に必要な時系列範囲が常にホット／ウォーム層から取得できるように設計することが重要です。

## コスト最適化とライフサイクルポリシー

PB 級のログを保管する場合、ストレージコストは長期運用で支配的な要素になりがちです。そのため、ライフサイクルポリシー (lifecycle policy) を用いて、一定期間ごとにストレージクラスを自動的に切り替える運用が一般的です。

- アクセス頻度や重要度に応じて、一定期間後にウォーム／コールド層へ自動移行するルールを設定する。
- 削除可能なデータ（例: テストキャンペーンで一時利用したデータ）は、保管期間終了後に自動削除する。
- 規制対応のために長期保管が必要なデータは、コールド層での保持期間を明示的に定義する。

データ中心の観点では、「いつでもすべてのデータに低レイテンシでアクセスできる」状態は理想的ですがコスト的に非現実的なため、「どのユースケースがどのレイテンシを必要とするか」を明確化し、それに合わせたライフサイクル設計を行うことが重要です。

さらに、法規制や社内ポリシーによる保持期限もライフサイクル設計に組み込む必要があります。例えば、

- 事故やインシデントに関するログは、法的要求に基づき一定期間（数年など）保管する。
- 研究用途の生センサログは、一定期間後に匿名化された統計量のみを残し、元データは削除する。

といったルールです。Closed-Loop データエンジンでは、「どのレイヤ・どの期間のデータがどの目的で保持されているか」をメタデータとして明示し、不要なデータが惰性で残り続けることを避けることが重要です。

