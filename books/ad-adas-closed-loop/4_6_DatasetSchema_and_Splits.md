# 4.6 データセットスキーマ・スプリット設計

この節では、データセットスキーマ (dataset schema) と Train / Validation / Test / Long-tail / ODD 別セットなどのスプリット設計について解説します。時系列リーク防止・地理的スプリット・シナリオベーススプリット、バージョニングと再現性の確保を整理し、データ中心・Closed-Loop の観点から「評価指標の信頼性」を高めるための設計を考えます。ここでいうスキーマとは、データセットを構成するテーブルやファイルの構造（カラム名・型・意味・関係）と、スプリットやバージョンに関するメタデータの定義を指します。

## スプリット設計の基本原則

一般的な ML と同様に、Train / Validation / Test のスプリットは必須ですが、自動運転では時系列相関や地理的相関が強いため、単純なランダムスプリットでは過大評価になりやすいです。

- 時系列リーク防止: 同じ Drive や Scene が複数のスプリットにまたがらないようにする。
- 地理的スプリット: 特定地域や道路を Test 専用にすることで一般化性能を測る。
- ODD セグメント別スプリット: 雪道や夜間など特定条件を含む Test セットを設ける。

公開ベンチマーク（nuScenes, Waymo Open Dataset 等）でも、Drive 単位でのスプリットや都市単位でのスプリットが採用されており、これにより「同じ場所・同じ日時のシーンが Train と Test に跨る」ことを防いでいます。実務でも、走行 ID / 車両 ID / 日付などのキーを用いたグループ分割を標準とし、「フレーム単位のランダム分割」は避けることが望ましいです。

また、Validation セットの役割（ハイパーパラメータ調整やモデル選択）と Test セットの役割（最終評価・レポーティング）を明確に分離し、Test セットの情報が日常的な開発ループに流入しないように運用上のガード（アクセス制御・ジョブ制約など）を設けることも重要です。

## Long-tail / ODD 別セット

ロングテール性能や特定 ODD での性能を重点的に評価するため、Long-tail セットや ODD 別セットを明示的に定義します。

- Long-tail セット: ヒヤリハットやレアイベントを集約したセットで、主に安全性評価に用います。
- ODD 別セット: 都市高速・郊外・降雪など、ODD セグメントごとに代表シーンを集めたセットです。

Closed-Loop の観点では、これらのセットのメトリクスを継続的に追跡し、弱点がどのセグメントに集中しているかを明らかにすることが重要です。

実務では、Long-tail セットや ODD 別セットを「通常の Test セットとは別の評価スイート」として管理し、安全レビューやリリースゲート（第 8 章）で用いることが多いです。例えば、

- ベースライン Test セット：運用分布に近い構成で、平均性能を測る。
- セーフティ Test セット：ロングテールシナリオ・ヒヤリハット・インシデントに特化し、保守性を評価する。
- ODD 別 Test セット：地域・天候・時間帯ごとの性能を比較し、展開対象 ODD の妥当性を検証する。

といった複数のセットを用意し、それぞれに対して KPI や合否基準を定義します。Closed-Loop の中では、インシデント分析やアクティブラーニングで新たに見つかったシナリオを、適切な Test セットに追加していくことで、「評価セット自体が成長する」サイクルを作ることができます。

## バージョニングと再現性

データセットはバージョン管理し、「どのモデルがどのデータセットバージョンで評価されたか」を追跡できるようにします。これにより、データセット更新（ラベル修正やスプリット変更）があっても、過去のモデルとの公平な比較が可能になります。

データセットバージョニングを設計する際には、少なくとも次の情報をメタデータとして持たせると良いです。

- スキーマバージョン：カラム構成・データ型・意味がいつ・どのように変更されたか。
- 前処理バージョン：4.5 節で述べたフォーマット変換・リサンプリング・特徴量抽出のバージョン。
- スプリット定義：Train / Val / Test / Long-tail / ODD 別セットの定義方法と、具体的なインデックス。
- ラベルポリシーバージョン：第 5 章で述べるラベル定義・ポリシーのバージョン。

データセットバージョン管理の実装方法としては、データバージョニングツール（DVC, LakeFS, Delta Lake 等）を用いる方法や、メタデータストア（自社開発のカタログ、あるいはオープンソースのデータカタログツール）にデータセットのスナップショット情報を登録する方法があります。重要なのは、「特定のモデル実験がどのデータスナップショットと結びついているか」が一意に参照できることです。

## データセットスキーマ設計のポイント

スプリット設計と並んで重要なのが、データセットスキーマの設計です。自動運転では、少なくとも以下のようなエンティティと関係をスキーマとして明示することが多いです。

- Drive / Trip テーブル：走行 ID、車両 ID、日時、地域、天候など。
- Scene / Clip テーブル：Drive 内の区間、開始・終了時刻、シナリオ種別ラベルなど。
- Frame テーブル：タイムスタンプごとのセンサフレーム（画像・点群・Radar 等）へのパス。
- Object / Track テーブル：物体 ID、クラス、2D/3D バウンディングボックス、軌跡など。
- マップ・ランドマークテーブル：レーン、交差点、信号、標識などの静的情報。

これらのテーブルに対し、主キー・外部キー・一貫性制約を明示し、スプリット情報をカラムや別テーブルとして持たせます。例えば、Scene テーブルに `split` カラムを持たせ、「train」「val」「test」「oddsnow」「longtail」などの値を割り当てると、簡潔なクエリで特定のセットを抽出できます。

## Closed-Loop におけるスキーマ／スプリット運用

Closed-Loop の観点では、スキーマやスプリットも「変化し続けるもの」として扱う必要があります。ODD の拡張やラベルポリシーの見直しに伴い、

- 新しいクラスや属性がスキーマに追加される。
- 既存のスプリット定義が見直され、新しい Test セットが定義される。

といった変更が発生します。このとき、以下のような運用が重要です。

- スキーマ変更はマイグレーションスクリプトとして管理し、必要に応じて旧バージョンから新バージョンへの変換を行う。
- スプリット定義の変更は、実験管理ツールと連携し、「モデル v1.2 は dataset v3, split v2 で評価された」と追跡できるようにする。
- スキーマ・スプリットに関する仕様書を docs やデータカタログにまとめ、組織内で共有する。

このように、データセットスキーマとスプリット設計を「一度決めて終わり」ではなく、Closed-Loop の一部として継続的に管理することで、長期にわたる自動運転モデル開発の土台として信頼性の高い評価基盤を維持できます。

