# 3.3 センサー間の時刻同期とタイムスタンプ整合

この節では、クラウド側での時刻同期 (time synchronization) 情報の扱いとタイムスタンプ整合について解説します。Clock drift の補正や再サンプリング、センサー固有遅延のモデリングと補正方法を整理し、データ中心・Closed-Loop の観点から、時刻情報が学習・評価に与える影響を説明します。

## Clock drift の補正と再サンプリング

車両上では、GPS 時刻や PTP により高精度な同期を行っていても、実際のログには微小な Clock drift や遅延が含まれることが多いです。クラウド側の処理では、以下のような補正を行うことがあります。

- センサーごとのタイムスタンプと基準クロック（例: ECU 時刻）との差分を推定し、補正曲線を適用する。
- 高レートセンサーデータを、下流で扱いやすい周期に再サンプリングする。
- マルチセンサーのデータを、一定の時間窓でグルーピングしてフレーム単位のサンプルを構成する。

こうした処理は、特に BEV 表現や世界モデルの構築など、複数センサーの同期が前提となるタスクで重要です。Closed-Loop の観点では、時刻補正の品質がシミュレーションやログ再生時の挙動にも影響するため、メタデータとして補正パラメータを記録しておくことが望ましいです。

クラウド側での補正では、次のような実務的な手順がよく取られます。

- Drive 単位で「基準クロック」（多くは INS / ローカライゼーション ECU の時刻）を定める。
- 各センサーのタイムスタンプと基準クロックの差分を、セッション開始・終了時や一定間隔ごとに推定し、線形・分割線形モデルなどでドリフトを近似する。
- 必要に応じて、フレームレベルではなくサブフレーム（例: LiDAR スキャンライン）レベルでの補正を行う。

この補正モデル自体にも誤差は残るため、最終的に「どの程度の同期誤差が残っているか」を品質指標としてメタデータに保存しておくことで、後段の評価や学習で「同期誤差の大きいデータを除外・重みづけ」するといった運用が可能になります。

## センサー固有遅延のモデリングと補正

カメラ・LiDAR・Radar・CAN ログなどは、それぞれ取得から記録までの遅延特性が異なります。例えば、カメラ画像は露光時間分の遅延を含み、Radar はフィルタリング処理のレイテンシを含みます。これらを無視すると、「同じ時刻」と見なしているデータが実際には数十ミリ秒ずれている、といった問題が生じることがあります。

データ中心の観点では、センサー固有遅延をモデル化し、必要に応じてタイムスタンプにオフセットを加える、あるいは時刻同期推定アルゴリズムを適用することが重要です。特に、高速走行時や複雑な交差点での挙動を扱うタスクでは、数十ミリ秒のずれが空間的に大きな誤差に変換されることがあります。

センサー固有遅延の推定には、次のような方法があります。

- 試験場などで既知のターゲット（移動するライトパターン、同期用テストチャートなど）を用い、センサーごとの応答タイミング差をオフラインで測定する。
- 実走行ログから、同一イベント（例えば信号機の点灯、車両の急ブレーキ開始など）に対するセンサー応答時刻の差を統計的に推定する。
- INS やタイムサーバ（PTP Grandmaster など）の PPS／PTP 情報を基準に、各センサーのハードウェアタイムスタンプ誤差を解析する。

一度推定されたセンサー遅延は、キャリブレーションパラメータとして管理し、クラウド側の前処理で固定オフセットとして補正することが多いです。ただし、温度や電源状態により遅延が変化する場合もあるため、「遅延パラメータがどの条件のときに推定されたものか」をメタデータに含めておくことが望ましいです。

## 時刻同期メタデータと品質指標

時刻同期とタイムスタンプ補正は、データパイプラインの中で「見えにくい」部分ですが、その品質はモデル性能や評価結果に直接影響します。データ中心・Closed-Loop の観点では、次のようなメタデータと品質指標を設計し、Drive / Scene / Frame 単位で管理することが推奨されます。

- 使用した同期方式（PTP / NTP / PPS / GPS 直結など）とそのバージョン。
- センサーごとの推定同期誤差（例: カメラ vs LiDAR の最大／平均時間差）。
- ドリフト補正に用いたモデルの種類とフィット精度。

これらを持っておくことで、

- 同期品質が悪いログを学習データから除外する。
- 同期品質ごとにモデル性能を分解して評価する。

といった Closed-Loop の工夫が可能になります。例えば、「PTP を導入した後のログでは、LiDAR-Camera フュージョンタスクの誤差がどれだけ改善したか」をデータレベルで確認するといった分析が行えるようになります。

