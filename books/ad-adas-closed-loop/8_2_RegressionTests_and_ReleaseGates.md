# 8.2 リグレッションテストとリリースゲート

この節では、リグレッションテストとリリースゲートについて解説します。オフライン指標・シミュレーション・HiL 結果によるゲート設計、「リリースしてよいか？」を決める基準値とプロセスを整理し、データ中心・Closed-Loop の観点から「モデル更新のたびにどのデータで何を確認するか」を明確にします。

## リグレッションテストの役割とスコープ

リグレッションテスト (regression test) は、「既に動いていた機能が、新しい変更によって壊れていないか」を確認するためのテストです。自動運転・ADAS の場合、対象は単なるソフトウェア API ではなく、車両挙動や安全メトリクスまで含まれます。そのためリグレッションテストは、以下のような層に分かれることが多いです。

- コードレベル: ユニットテスト、統合テスト、静的解析、コードカバレッジ
- モデルレベル: オフライン指標（mAP, mIoU, trajectory error など）による性能比較
- システムレベル: シミュレーション (SiL) や HiL による Closed-Loop 挙動の比較
- フリートレベル: 実運用テレメトリに基づく KPI（介入率、ヒヤリハット率など）の比較

第 8 章で扱うリリースゲート (release gate) は、これら複数層のリグレッションテスト結果をまとめ、「どの条件を満たせばリリース可能とみなすか」を形式化した意思決定ポイントです。単に「平均精度が上がったからリリースする」のではなく、「安全に関する指標が悪化していないか」「特定 ODD セグメントでの退行がないか」を含めて判断することが重要です。

## オフライン指標ベースのゲート設計

最も基本的なリリースゲートは、オフライン指標 (offline metrics) に基づくものです。例えば認識 (perception) モデルの場合、以下のような指標が用いられます。

- 物体検出: mAP (mean Average Precision)、クラス別 AP、距離レンジ別 AP
- セマンティックセグメンテーション: mIoU (mean Intersection-over-Union)、クラス別 IoU
- 車線検出: 検出率、誤検出率、位置ずれ誤差

予測 (prediction)・経路計画 (planning) モデルでは、

- 予測軌道誤差（ADE: Average Displacement Error、FDE: Final Displacement Error）
- 衝突予測に関する指標（Collision Rate、Time-To-Collision 閾値内の侵入頻度）
- 計画軌道の快適性・効率性（最大加速度・ジャーク、到達時間など）

といった指標が挙げられます。これらの指標を用いて、典型的には以下のようなゲートルールを設定します。

- 「グローバル評価データセットにおいて、ベースラインモデルに比べて主要指標が一定以上悪化していないこと」（例: mAP の劣化が 0.5 pt 未満）
- 「ターゲットシナリオデータセット（改善対象）において、特定の指標が一定以上改善していること」（例: 夜間・雨天シーンでの歩行者 AP が +2 pt 以上）
- 「安全関連クラス（歩行者、自転車、二輪車など）に関する指標が劣化していないこと」

データ中心・Closed-Loop の観点では、「どのデータセットをゲートに使うか」がゲートルールそのものと同じくらい重要です。ゲート用データセットは、日々の学習に用いるトレーニングデータとは別に、「リグレッションテスト専用の評価データセット」として厳密に管理します。これにより、長期にわたって指標の推移を比較できるとともに、「ゲート用データセットに過度にフィットしてしまう」ことを避けるための運用ルール（定期的な更新や拡張）も設計できます。

## シミュレーション・HiL を含む多段リリースゲート

オフライン指標が十分であっても、実車の Closed-Loop 挙動が安全であるとは限りません。そのため実務では、シミュレーション (simulation-in-the-loop; SiL) や Hardware-in-the-Loop (HiL) を含む多段のリリースゲートを設計することが多いです。

典型的な多段ゲートの例を挙げます。

1. 静的ゲート  
   - コードスタイル・静的解析・セキュリティスキャンの結果が許容水準を満たしていること。  
   - クリティカルな警告（バッファオーバーフローの可能性など）が残っていないこと。
2. ユニット・コンポーネントレベルゲート  
   - 各モジュールのユニットテストが全て成功していること。  
   - 変更の影響範囲にあるコンポーネントの統合テストが成功していること。
3. オフライン指標ゲート  
   - 前述の評価データセットに対して性能指標がベースラインと比較して許容範囲内であること。
4. シミュレーションゲート  
   - 代表的なシナリオセット（交差点右折、合流、車線変更など）において、シミュレーション上の安全指標（衝突有無、最小 TTC、車線逸脱など）が基準を満たしていること。
5. HiL ゲート  
   - ターゲット ECU 上でコンパイル後バイナリを実行し、リアルタイム性やリソース使用量（CPU 負荷、メモリ使用量）が許容範囲内であること。  
   - フォールトインジェクション (fault injection) に対して安全側の挙動を示すこと。
6. ステージング車両ゲート  
   - 社内フリートや限定エリアの試験車両で、一定距離・時間の運用において重大インシデントや介入率の悪化がないこと。

各ゲートの条件は、単なるドキュメントではなく「ポリシー as Code」として CI/CD パイプラインに組み込むことが望ましいです。これにより、開発者がローカル環境や開発ブランチでも同じチェックを事前に実行でき、「いざリリース時にゲートで止まる」という事態を減らせます。

## ゲート用データセットとシナリオスイートの設計

リリースゲートが機能するかどうかは、「どのデータとシナリオで評価しているか」に大きく依存します。データ中心の観点では、ゲート用データセットとシナリオスイートの設計・運用自体を 1 つの重要なタスクとして扱います。

### ゲート用評価データセット

ゲート用評価データセットには、以下のような性質が求められます。

- 長期的に安定しており、指標の推移を比較しやすいこと（頻繁に中身を総入れ替えしない）。
- ODD セグメント別のバランスが取れていること（都市高速、郊外、夜間、悪天候など）。
- 過去にインシデントやヒヤリハットが多かったシナリオを重点的に含むこと。
- 再現性のために、データセットのバージョンが厳密に管理されていること。

4 章・5 章で扱ったデータ選択とラベリングの仕組みを用いて、「新たに発見されたリスクシナリオをどのタイミングでゲート用データセットに組み込むか」というルールも決めておくとよいです。例えば、「一定回数以上のインシデントが発生したシナリオクラスは、次のリリースサイクルからゲート用データセットに追加する」といった運用が考えられます。

### シナリオベーステストスイート

7 章で扱ったシナリオベーステスト (scenario-based testing) の観点からは、リリースゲート用に専用のシナリオスイートを定義します。

- ルールベースシナリオ: 交通ルールに基づいた代表的な状況（優先道路進入、横断歩道の歩行者、ラウンドアバウトなど）。
- ロングテールシナリオ: 実際のインシデント・ヒヤリハットから抽出された難しい状況。
- ストレステストシナリオ: ギリギリのマージンで挙動が安全と危険の境界にある状況。

これらのシナリオごとに、「合格条件」を明示します。例えば、「このシナリオでは、被験車両が歩行者から 2 m 以上の距離を保ったまま停止できること」「追突の Time-To-Collision が常に 1.5 s 以上となること」などです。リリースゲートでは、「すべての必須シナリオを合格すること」「推奨シナリオのうち 95 % 以上を合格すること」といったルールを設定できます。

## 実務的なゲートルールの例

ここでは、現場でよく見られる具体的なゲートルールの例をいくつか挙げます。実際のプロジェクトでは、安全目標や規制要件に応じて数値や詳細は変わりますが、考え方の参考になります。

- 例 1: 認識モデルのリリースゲート  
  - 全体 mAP はベースラインから -0.5 pt 以内。  
  - 歩行者・自転車クラスの AP はベースラインから -0.0 pt（すなわち悪化なし）以上。  
  - 新たに追加したクラス（例: 台車、電動キックボード）はベースラインより +3 pt 以上改善。  
  - シミュレーション上の代表的歩行者飛び出しシナリオ 50 ケース中、衝突ゼロ。

- 例 2: 経路計画モデルのリリースゲート  
  - シミュレーション上の 1 万シナリオにおいて、車線逸脱ゼロ。  
  - 最小横方向加速度・ジャークが事前に定めた快適性閾値以下。  
  - HiL 上での最大 CPU 使用率が 70 % 未満、かつ 10 分間のテストで期限超過フレームがゼロ。

- 例 3: システムリリース全体のゲート  
  - 安全関連の既知重大不具合が未解決のまま残っていないこと。  
  - ステージング車両での累計 1 万 km 走行において、重大インシデントゼロ、介入率がベースラインと同等以下。  
  - すべてのテスト・シミュレーション結果がトレーサブルに記録され、将来の監査・安全審査に耐えうること。

これらのルールは、単に「一度決めて終わり」ではなく、Closed-Loop に基づいて継続的に更新する前提で設計します。例えば、実運用から得られたインシデント分析の結果、「従来のゲートでは検出できなかったリスク」が見つかった場合、それを検出できる新たなシナリオやメトリクスをゲートに追加していきます。

## Closed-Loop とリリースゲートの接続

リリースゲートは、「開発側が品質を保証するための最後の砦」であると同時に、「運用から得られた知見を開発に戻すためのインターフェース」でもあります。Closed-Loop の観点からは、以下のような流れが重要です。

1. 実運用モニタリング（8.5 節）やインシデント収集（8.6 節）により、新たなリスクパターンやロングテールシナリオが検出される。
2. これらのシナリオがデータセット設計（4 章）とシミュレーション・テスト設計（7 章）に取り込まれ、ゲート用データセットおよびシナリオスイートが更新される。
3. 次回以降のリリースでは、更新されたゲートに対してモデルが評価されることで、同じ種類の問題が再発しないようにする。

このループを機能させるためには、リリースゲートの定義自体をコード化・バージョン管理し、「どのリリース時点でどのゲートが有効だったか」を後から再現できるようにしておくことが重要です。これにより、特定のインシデントが発生した際に、「当時のゲート定義ではどのようなテストを通過していたのか」「どのようなリスクが未カバーだったのか」を振り返り、ゲートを段階的に強化していくことができます。

