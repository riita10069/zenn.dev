---
title: "7.7 クラウド上の仮想 ECU を用いた HiL・コンパイル後評価"
---

# 7.7 クラウド上の仮想 ECU を用いた HiL・コンパイル後評価

この節では、クラウド上の仮想 ECU を用いた Hardware-in-the-Loop (HiL)・コンパイル後評価について解説します。実 ECU と同等環境での実行時間・リソース測定、コンパイル後バイナリ（量子化後含む）の検証、通信・故障シナリオのテストを整理し、データ中心・Closed-Loop の観点から「本番バイナリの挙動を事前にデータドリブンで検証する」設計を考えます。

## 仮想 ECU・HiL の役割

第 7.4 節で述べた SiL が「ソフトウェアを純粋な仮想環境で動かす」のに対し、Hardware-in-the-Loop (HiL) は、実 ECU や実ハードウェアに近い環境でソフトウェアを動作させる評価形態です。近年は、クラウド上に仮想 ECU (virtual ECU) を構築し、物理 ECU と同等の OS・ランタイム・ミドルウェア環境を再現するアプローチも広がりつつあります。

仮想 ECU・HiL の主な目的は以下の通りです。

- コンパイル後バイナリ（量子化・最適化済みモデルを含む）の性能・リソース消費の確認。
- 通信遅延・バス負荷・フォールトインジェクションなど、ECU 間通信を含むシナリオの検証。
- 実ハードウェアでの評価前に、多数のシナリオを安価に回すための「前段階のフィルタ」として機能すること。

## コンパイル後バイナリの性能・精度検証

実車 ECUs では、推論ライブラリやハードウェアアクセラレータ向けにモデルをコンパイルし、量子化や演算順序の変更を行うことが一般的です。このプロセスで、精度や挙動が微妙に変化する可能性があります。仮想 ECU を用いると、以下のような検証を効率的に行うことができます。

- 精度検証:
  - トレーニング時の FP32 モデルと、コンパイル後の INT8/FP16 モデルの出力を比較し、オフライン指標の差分を測定する。
  - 特にロングテールなシナリオについて、誤検出・見逃しが増えていないかを重点的に確認する。
- 性能・リソース検証:
  - 1 フレームあたりの推論時間、CPU/GPU 使用率、メモリ使用量を測定し、リアルタイム制約（例: 30 ms 以内）を満たしているか確認する。
  - 複数モデル・複数タスクを同一 ECU 上で動作させたときのリソース競合を検証する。

これらの検証結果は、第 8 章で扱うリリースゲート条件の一部として扱われることが多いです。データ中心・Closed-Loop の観点では、「どのシナリオでコンパイル後モデルの劣化が顕著か」を把握し、必要に応じて再学習やデータ拡張を行うことが重要です。

## 通信・故障シナリオのテスト

仮想 ECU・HiL 環境では、ECU 間通信やフォールトインジェクション (fault injection) を含むシナリオを柔軟に構成できます。代表的なテスト内容としては次のようなものがあります。

- 通信遅延・パケットロス:
  - センサ ECU からメイン ECU へのフレーム配送に遅延・ドロップを挿入し、モデルや制御ロジックがどのように振る舞うかを確認する。
  - タイムスタンプのズレや順序入れ替わりが発生した場合のロバスト性を検証する。
- フォールトインジェクション:
  - センサ値の一定期間フリーズ、異常値注入、ランダムなスパイクなどを生成し、安全監視・フェイルセーフが適切に動作するかを確認する。
  - ECU 再起動・一時的な通信断など、実車では再現しにくい故障シナリオを試験する。
- 非機能要件:
  - 長時間連続運転時のメモリリークやリソース枯渇の有無。
  - バージョン違いの ECU 間互換性（混在フリート）に関する検証。

これらのテスト結果もシナリオ DB と紐付けて管理することで、「どの機能がどの故障シナリオに対して耐性を持っているか」を体系的に把握できます。

## クラウドベース HiL 基盤のアーキテクチャ

クラウド上の仮想 ECU を用いた HiL 基盤は、概ね次のような構成要素から成ります。

- 仮想 ECU イメージ:
  - 実 ECU と同一 OS・ミドルウェア・ランタイムを含むコンテナ／VM イメージ。
  - モデルバイナリや設定ファイルを含むデプロイパッケージ。
- シミュレーションゲートウェイ:
  - シミュレータからのセンサデータを、実 ECU で使われているプロトコル（CAN、Ethernet、DDS など）に変換して仮想 ECU に送信する。
  - 仮想 ECU からのコマンドをシミュレータに戻す。
- オーケストレーション:
  - 多数の仮想 ECU インスタンスをクラスタ上で起動・停止し、シナリオごとに適切な構成を割り当てる。
  - 実行ログ・メトリクスを一元的に収集し、第 7.8 節のレポート基盤に連携する。

クラウドベース HiL の利点は、物理 HiL ベンチに比べてスケーラビリティが高く、モデルや ECU 構成のバリエーションを柔軟に試せる点にあります。一方で、タイミング精度やハードウェア依存の挙動再現には限界があるため、最終的な認証試験などでは物理 HiL との併用が望ましいと考えられます。

## Closed-Loop における仮想 ECU の位置づけ

データ中心・Closed-Loop の観点では、仮想 ECU・HiL 評価は次のようなループに組み込まれます。

1. 第 6 章で学習・オフライン評価されたモデルを、ターゲット ECU 向けにコンパイル・最適化する。
2. 仮想 ECU 上でシナリオベース SiL / HiL テストを実行し、性能・精度・安全性を評価する。
3. 問題が見つかったシナリオをシナリオ DB に登録・更新し、データ選択・ラベリング・学習パイプラインにフィードバックする。
4. 必要に応じて ECU 構成やリソース配分を見直し、第 8 章で扱うデプロイ戦略に反映する。

このループを回すことで、「学習済みモデルはオフラインでは良さそうだが、実 ECU 上では遅すぎて使えない／微妙に挙動が違う」といったギャップを早期に検出し、データとモデルの両面から対策を打つことが可能になります。
