# 4.7 シーン検索 UI と自然言語・ラベル検索

この節では、シーン検索 UI と自然言語・ラベル検索について解説します。「雨の夜の合流」「右折時の自転車」などの自然言語クエリ、ラベル・センサーデータ・テレメトリを組み合わせた検索、Embedding ベースの類似シーン検索の役割を整理し、データ中心・Closed-Loop の観点から「必要なシーンにすぐアクセスできること」が改善サイクルに与える影響を考えます。膨大なフリートログの中から特定の条件を満たすシーンを素早く見つけられるかどうかは、エラー分析・データ選択・アクティブラーニングの効率を大きく左右します。

## 自然言語クエリとメタデータ検索

近年は、大規模言語モデルやテキストエンコーダを用いて、自然言語クエリからシーンを検索するアプローチが広がっています。「雨で、夜で、右折中に歩行者が横断しているシーン」といった人間にとって自然な記述を、メタデータや埋め込み空間に投影して検索するものです。

自然言語ベースのシーン検索では、一般に次のような構成を取ります。

- メタデータ層：天候、時間帯、場所、センサー状態、シナリオタグなどを RDB / データウェアハウスに格納し、SQL やクエリエンジンでフィルタリングできるようにする。
- テキスト・ラベル層：アノテーション（オブジェクトクラス、属性、シナリオラベル）をドキュメントとして格納し、全文検索エンジン（Elasticsearch / OpenSearch 等）で検索可能にする。
- 自然言語クエリ層：ユーザーが入力した自然言語クエリをテキストエンコーダでベクトル化し、シーンやラベル側のベクトルと類似度検索を行う。

テキストエンコーダとしては、一般的な言語モデルや CLIP 系のテキストエンコーダ、タスク特化型のエンコーダなどが利用されます。これらのエンコーダは、シーンの要約テキスト（例: 「高速道路の夜間、雨、合流車線からの車線変更シーン」）との類似度に基づいてシーンを検索することができます。

## Embedding ベースの類似シーン検索

ビデオ・画像・センサデータをエンコーダで埋め込みベクトルに変換し、その近傍検索により類似シーンを探す手法も有効です。モデルの失敗シーン周辺の類似シーンをまとめて抽出し、ラベリングや再学習対象にする、といった活用が考えられます。

Embedding ベースの検索では、

- 画像・動画エンコーダ（自社モデルや公開モデル）でフレーム／シーンを固定次元のベクトルに変換する。
- テレメトリやマップ情報などの非画像特徴もベクトルに組み込み、マルチモーダルな埋め込みとする。
- ベクトルデータベース（Faiss, Annoy, HNSWlib, Milvus 等）を用いて、高速な近傍検索 (Approximate Nearest Neighbor; ANN) を行う。

といった構成が一般的です。これにより、ある失敗シーンに似たシーンを数百〜数千件単位で素早く取得し、ラベリング・再学習・シミュレーション用シナリオ抽出などに活用できます。

## シーン検索 UI の設計

エンジニアやアノテータが日常的に利用するシーン検索 UI では、使い勝手が Closed-Loop の速度に直結します。一般的な UI では、次のような機能が求められます。

- メタデータフィルタ：時間帯、天候、地域、速度レンジ、センサー状態などの条件で絞り込み。
- ラベルベース検索：特定クラス（例: 歩行者、自転車）、属性（例: 信号無視、横断中）、シナリオタグ（例: 車線変更、合流）による検索。
- 自然言語クエリ入力欄：自由記述で条件を指定し、内部でメタデータフィルタと埋め込み検索に変換する。
- 類似シーン検索：あるシーンから「類似シーンを検索」ボタンを押すことで、近傍 Embedding を持つシーンを一覧表示。
- プレビューとラベリング連携：検索結果から直接ビューワを開き、アノテーションツールやタグ付けワークフローに送る。

バックエンドとしては、一般的な検索エンジン（Elasticsearch / OpenSearch 等）、ベクトル検索エンジン、メタデータ用の RDB / データウェアハウスなどを組み合わせる構成が多いです。特定の製品に依存せず、「メタデータ検索」「全文検索」「ベクトル検索」をそれぞれ独立したコンポーネントとして設計すると、将来的な入れ替えが行いやすくなります。

## Closed-Loop とシーン検索の連携

Closed-Loop の観点では、シーン検索はエラー分析・アクティブラーニング・シミュレーションと密接に結びつきます。

- オフライン評価や実車テレメトリから抽出した失敗ケースを、シーン検索 UI から再現し、似たシーンを合わせて確認する。
- 特定の ODD セグメントやシナリオで性能が低いことがわかった場合、その条件を自然言語やメタデータで指定し、追加データ候補を抽出する。
- シミュレーション用シナリオ（第 7 章）を生成する際に、実世界ログから代表シーンを検索・抽出し、パラメトリックにバリエーションを増やす。

このようなループを効率的に回すためには、シーン検索 UI を単なる「ビューア」ではなく、データ選択・ラベリング依頼・シナリオ生成・学習ジョブ起動など他システムへの入口として位置づけることが有効です。例えば、検索結果をそのまま「新しい学習データセット候補」としてエクスポートし、データセット管理ツール（4.6 節）に登録できるようにしておくと、データ中心の改善サイクルを高速に回せます。

