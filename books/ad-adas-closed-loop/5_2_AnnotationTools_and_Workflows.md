# 5.2 アノテーションツールとワークフロー設計

この節では、アノテーションツールとワークフロー設計について解説します。2D/3D ラベリング、時系列トラッキング、マルチセンサフュージョン、キーボードショートカットや半自動補完による効率化、スクリプト拡張・プラグインなどを整理し、データ中心・Closed-Loop の観点から「ラベリング生産性と品質を両立する仕組み」を考えます。

## 2D/3D・時系列・マルチセンサのサポート

自動運転のラベリングツールには、以下のような機能が求められます。

- 2D 画像上でのバウンディングボックス、ポリゴン、セマンティックセグメンテーション。
- 3D 点群上での 3D ボックス、ベクトルラベル、地物ラベル。
- 時系列トラッキング（ID 付与、オクルージョン管理）。
- マルチカメラ・LiDAR・マップの同期表示。

## 効率化と品質維持のための機能

- キーボードショートカットやテンプレートを用いた高速操作。
- 半自動補完（過去フレームからのトラッキング、既存モデルによる候補生成）。
- スクリプトやプラグインによるカスタム検査ルールの実装。

Closed-Loop の観点では、ラベリングツールを単なる「作業装置」としてではなく、エラー分析結果やモデル出力を反映する「インタラクティブな改善環境」として設計することが重要です。

## 代表的なアノテーションツールに共通する機能要件

自動運転向けデータセットを対象としたオープンソース／商用のアノテーションツール（CVAT、Scalabel、LabelMe を拡張したツールなど）では、共通して次のような機能が提供されています。

- **シーケンスベースの編集**  
  静止画だけでなく、数百〜数千フレームにわたる動画としてデータを扱い、トラッキング ID の引き継ぎやフレーム間補間をサポートします。これにより、同じ物体に対してフレームごとにバウンディングボックスを描き直す必要がなくなります。
- **マルチセンサビューの同期表示**  
  前後左右のカメラ、トップビュー BEV、LiDAR 点群、HD マップなどを同時に表示し、1 つのオブジェクトに対して 2D / 3D ラベルを統合的に編集できる UI が求められます。Scalabel のように 2D/3D 両方のアノテーションを扱えるツールは、センサフュージョン (sensor fusion) モデルとの相性が良いです。
- **プラグイン・スクリプトによる拡張性**  
  Python や JavaScript で書かれたスクリプトからカスタムチェックや自動修正を呼び出せる仕組みがあると、プロジェクト固有のルール（例: 「車線境界を 50cm 以上またがる車両に警告を出す」）を簡単に組み込めます。
- **タスクと権限管理**  
  ラベラー、レビュアー、管理者などのロールを定義し、タスクの割り当てや状態管理（未着手 / 進行中 / レビュー待ち / 完了）を行えることが重要です。後述する品質管理やベンダー比較にも直結します。

これらの機能要件は単なる「ツールの便利さ」にとどまらず、データ中心・Closed-Loop な開発において、データ増強・エラー分析・再ラベルを高速に回すための基盤になります。

## ワークフロー設計とロール分担

アノテーションワークフロー (annotation workflow) を設計する際には、以下のようなロールとステップを分解して考えると整理しやすいです。

1. **タスク定義 (task definition)**  
   どのデータセットから、どのクラス・属性・シナリオタグを付与するかを定義します。例えば「雨天・夜間の交差点シーン 10,000 フレームに対して、歩行者と自転車の 3D ボックスとトラッキング ID を付与する」といった形です。
2. **タスク割り当て (assignment)**  
   ラベラーのスキルやトレーニング状況に応じて、難易度の高いシーン（合流・渋滞・工事区間など）を熟練アノテータに集中させる設計も有効です。多くのツールは、Web UI 上での自動割り当て機能を備えています。
3. **一次アノテーション (primary labeling)**  
   アノテータがツール上でラベルを作成・編集するフェーズです。ここで、前節の半自動補完機能やショートカット設計が効いてきます。
4. **レビュー・修正 (review & correction)**  
   レビュアーがサンプルまたは全件を確認し、誤りやポリシー逸脱を修正します。ツール側で「コメント」「修正履歴」「Before/After 差分表示」をサポートしていると、レビューの生産性と再現性が向上します。
5. **承認・エクスポート (approval & export)**  
   承認されたジョブだけがデータレイクやトレーニングパイプラインに取り込まれるよう、明確なゲート (gate) を設けます。承認ステータスはデータセットメタデータにも保存し、どのモデルがどのステータスのデータで学習されたかを追跡できるようにします。

Closed-Loop の観点では、オンライン評価やシミュレーションで見つかった問題シーンを「高優先度タスク」としてツールに投入し、上記ワークフローに自動的に流し込めることが重要です。これにより、「気付いた問題をすぐラベルキューに反映する」文化を形成できます。

## ツールとデータ基盤の統合

アノテーションツールは単体の SaaS/アプリケーションとしてではなく、データレイク・メタデータカタログ・実験管理システムと統合された一部として設計することが望ましいです。

- **シーン検索から直接タスク作成**  
  第4章で述べたシーン検索・クエリ機能と連携し、「特定の ODD・天候・シナリオ条件を満たすシーンを検索 → 検索結果をそのままラベリングタスクとしてキューに投入」というフローを実現します。
- **モデル出力との連携**  
  現行モデルの検出結果や不確実性スコアをツール上にオーバーレイ表示し、アノテータが「モデルが見落としている物体」「誤検出している物体」を素早く見つけられるようにします。これは半自動ラベリングやアクティブラーニングとも密接に関係します。
- **監査ログと再現性**  
  誰がいつどのフレームにどのラベルを付け、どのような変更が行われたかを、監査ログとして保存します。ISO 26262 や SOTIF などの安全規格の観点からも、データ生成プロセスのトレーサビリティを確保することが求められます。

このように、アノテーションツールとワークフロー設計は、単に UI/UX の話ではなく、Closed-Loop なデータエンジン全体の一部として設計されるべきものです。ツール選定時には、「単発のラベリングプロジェクトに使えるか」だけでなく、「数年スパンのデータ中心開発サイクルを支えられるか」という観点で評価することが重要です。
