---
title: "2.5 車載データ収集ソフトウェアスタックとログフォーマット"
---

# 2.5 車載データ収集ソフトウェアスタックとログフォーマット

この節では、車載データ収集ソフトウェアスタックとログフォーマット設計について解説します。データロガー、ECU、ミドルウェア (middleware; 例: ROS) の役割分担、時刻同期 (time synchronization) の方法、ログフォーマット（ROS bag / 独自バイナリ / WebDataset の元データなど）の設計を整理します。データ中心・Closed-Loop の観点から、後段のインジェスト・検索・学習を見据えたログ構造の重要性を説明します。

## データロガー・ECU・ミドルウェアの役割

車載ソフトウェアスタックは、一般的に以下のようなコンポーネントから構成されます。

- ECU (Electronic Control Unit): センサー制御・前処理・推論・制御を行う計算ノードです。複数 ECU 間で機能を分担する構成が多いです。
- ミドルウェア (例: ROS / DDS / 独自フレームワーク): センサー・モジュール間のメッセージングとトピック管理、QoS 制御などを担います。
- データロガー (data logger): ミドルウェア上のトピックや ECU 内部の信号を取得し、ストレージに記録するコンポーネントです。

データ中心の観点では、「どのトピックをどのレート・精度でロギングするか」「どの ECU 内部信号をログとして外部に露出させるか」を設計することが重要です。Closed-Loop のデバッグ・評価を考えると、最終的な制御コマンドだけでなく、中間表現やモデルの不確実性、診断情報なども適切に記録しておきたい場合が多いです。

### ミドルウェア選定とメッセージ設計

多くの自動運転プロジェクトでは、ROS / ROS 2 や DDS ベースのミドルウェア、あるいは独自のメッセージングフレームワークが利用されています。ミドルウェアの選定自体は本書のスコープ外ですが、データ中心の観点からは次のような点が重要です。

- メッセージスキーマ（IDL）が明確に定義され、バージョン管理されているか。
- トピック名・名前空間に一貫性があり、後からクエリしやすい形になっているか。
- QoS 設定（信頼性・遅延・ヒストリ）とロギング戦略が整合しているか。

ログフォーマット設計は、これらのメッセージスキーマに直接依存します。たとえば、「perception/objects」トピックに含まれるオブジェクトリストが、データレイク上ではどのようなテーブル構造やファイル構造にマッピングされるか、といった設計が必要になります。

## 時刻同期（PTP / GPS / 車載ネットワーク）

複数のセンサー・ECU からのデータを統合するためには、高精度な時刻同期 (time synchronization) が不可欠です。代表的な手法として、以下のようなものがあります。

- GPS 時刻を用いた絶対時刻同期。
- PTP (Precision Time Protocol) によるネットワーク内の高精度同期。
- 車載ネットワーク（CAN / Ethernet）のフレームタイムスタンプと組み合わせた補正。

時刻同期が不十分な場合、センサー間の整合性が崩れ、学習・評価において大きな誤差を生むことがあります。データ中心・Closed-Loop の観点では、タイムスタンプの精度やドリフトをメタデータとして記録し、後段のインジェストや前処理で補正可能にしておくことが重要です。

実務では、次のような構成が一般的です。

- GPS もしくは専用タイムサーバをルートクロックとし、PTP により車載 Ethernet ネットワーク上の主要 ECU に時刻を配信する。
- それぞれのセンサーやカメラには、PTP 同期された ECU からのトリガ信号やタイムスタンプが付与される。
- CAN や LIN などのバス系信号については、ゲートウェイ ECU で PTP とのオフセットを推定し、補正用のメタデータとして記録する。

これにより、後段のインジェストやログ再生時に「同一時刻のマルチセンサー情報」を再構成しやすくなります。第 3 章の時刻同期・タイムスタンプ整合の節では、クラウド側での補正方法と合わせて詳しく扱います。

## ログフォーマット設計（ROS bag / 独自バイナリ / WebDataset 等）

ログフォーマットは、オンボードの書き込み性能、ストレージ容量、後段の解析・学習パイプラインとの親和性などを考慮して設計する必要があります。代表的な選択肢として、以下のようなものがあります。

- ROS bag: ROS ベースシステムで広く用いられるフォーマットで、トピック単位のメッセージログに適しています。
- 独自バイナリフォーマット: 書き込み効率や圧縮率、ランタイム負荷を最適化するために、自社フォーマットを採用するケースもあります。
- WebDataset 等のシャーディング形式: 学習・評価パイプラインでの高速なストリーミングを意識し、最初からシャード構造に近い形で記録する設計も考えられます。

Closed-Loop データエンジンの観点では、「ログフォーマットが後段のパイプラインにどの程度スムーズにつながるか」が重要です。オンボードでの記録形式とクラウド側での最終フォーマットを完全に一致させる必要はありませんが、変換・インジェストのコストやロスを最小化するように設計することが望まれます。

### ロギングレイヤとストレージ戦略

車載ロギングでは、ECU 内部のリングバッファ、オンボードストレージ上の一時ファイル、取り外し可能なストレージデバイス、クラウドへのアップロードキューなど、複数のレイヤが存在します。各レイヤでのフォーマットと保持期間を設計することで、以下のような要件を両立します。

- 常時走行中のデバッグ用に、直近数分〜数十分のデータをリングバッファとして保持する。
- イベント発生時には、その前後をひとまとまりの「シーン」として書き出し、アップロード対象とする。
- バックホール容量に応じて、シーン単位や Drive 単位でのローテーション・削除を行う。

データ中心・Closed-Loop の観点では、このロギングレイヤ構成が「どのインシデントに対してどれだけの前後情報を解析できるか」に直結します。例えば、常に前後 30 秒しか残していない構成では、長い時間スケールの挙動（渋滞の形成、長距離追い越しなど）を十分に分析できない可能性があります。

### メッセージ単位 vs シーン単位のフォーマット

ROS bag のようなメッセージログ形式は、オンラインデバッグや再生には適していますが、学習用データセットとして扱うには粒度が細かすぎることがあります。一方で、学習・評価の観点では、「シーン単位（数秒〜数十秒）」や「フレーム単位（単一時刻）」でデータをまとめる方が扱いやすい場合が多いです。

したがって、オンボード・クラウドを通じたログフォーマット設計では、

- オンボードではメッセージログ（トピック単位・時系列）を記録し、
- クラウド側で Drive / Scene / Frame 単位の構造化フォーマットに変換する、

といった二段階構成を取るケースが一般的です。この変換処理は第 3 章のインジェストパイプラインで詳述しますが、本節では「車載ログフォーマットは最終形ではなく、データエンジンへの入口である」という位置付けを意識しておくと良いです。

## ログ設計とプライバシー／セキュリティの接点

ログフォーマット設計は、プライバシー・セキュリティとも密接に関係します。2.8 節・2.9 節で詳しく扱うように、顔・ナンバープレート・車内映像などの扱いには特別な配慮が必要です。

- ログレイヤのどの段階で匿名化を行うか（オンボード vs クラウド）。
- ログファイルごとに暗号化・署名を行い、持ち出し時や共有時のリスクをどのようにコントロールするか。
- 高機密ログ（社内のみ閲覧可）と低機密ログ（外部ベンダーと共有可能）をどのようなフォーマットとパスで分離するか。

データ中心・Closed-Loop の観点では、「データを使いたいときに使えない」「規制上使ってはいけないデータを使ってしまう」といった状態はどちらも望ましくありません。ログフォーマット段階から、プライバシー・セキュリティ要件を織り込んだ設計を行うことで、後段の DataOps・MLOps をスムーズに運用できるようにすることが重要です。

