---
title: "6.3 モデルアーキテクチャの設計"
---

# 6.3 モデルアーキテクチャの設計

この節では、AD 向けモデルアーキテクチャ設計について解説します。BEV 表現・マルチカメラ・マルチモーダルフュージョン、世界モデル（World Model）・予測モデル・軌道生成モデル、End-to-End Planning vs モジュラー構成などを整理し、データ中心・Closed-Loop の観点から「アーキテクチャ選択とデータ要件の関係」を考えます。

## BEV 表現とマルチカメラ・マルチモーダルフュージョン

近年の自動運転モデルでは、Bird’s-Eye View (BEV) 表現が中心的な役割を担っています。複数のカメラや LiDAR、Radar から得られた情報を車両中心座標系の平面上に投影することで、地図や経路計画との整合性が取りやすくなります。

- マルチカメラ BEV: 複数カメラ画像を CNN / Transformer で特徴抽出し、幾何投影または注意機構を用いて BEV 空間に統合します（BEVFormer, PETR など）。
- マルチモーダルフュージョン: LiDAR の点群特徴、Radar のレンジ・速度情報、HD マップのレーン情報などを BEV グリッド上で統合します（BEVFusion 系の手法）。
- 時系列統合: 過去フレームの BEV 特徴を ConvLSTM や時系列 Transformer で統合し、時間的な一貫性を持った表現を構築します。

データ中心の観点では、BEV ベースアーキテクチャは「空間的に整合した教師ラベル」と「マルチセンサの時間同期」が前提となるため、第 2〜3 章で述べたセンサキャリブレーションやタイムスタンプ整合の品質が直接モデル性能に影響します。キャリブレーション誤差やタイムシフトがあると、BEV 上でオブジェクトが滲んだり二重に写ったりし、学習が不安定になります。

## 世界モデル・予測モデル・軌道生成モデル

世界モデル (world model) は、周囲環境と自車のダイナミクスを内部状態として保持し、将来のシーンを予測するモデルです。近年は大規模なログデータやシミュレーションデータを用いて、ビデオ予測や軌道予測を行う世界モデルの研究が盛んです。

自動運転スタックでは、しばしば次のような分解が用いられます。

- 知覚モデル (perception model): BEV 上や画像空間で、オブジェクト検出・セマンティックセグメンテーション・車線検出などを行います。
- 予測モデル (prediction model): 他車両・歩行者などの将来軌道を多モーダルに予測します。
- 軌道生成モデル (trajectory planning model): 予測結果と HD マップ、制約条件を考慮し、自車の将来軌道を生成します。

世界モデル的なアプローチでは、これらをまとめて「潜在空間上で将来のシーン分布をモデリングする」ことで、Sim2Real や Closed-Loop 評価との親和性を高めることが試みられています。例えば、ログリプレイにおいて世界モデルを用いて欠損情報を補完したり、新たなシナリオを合成したりすることが検討されています。

Closed-Loop の観点では、世界モデルや予測モデルの誤差構造がそのままプランニング・制御に影響するため、「どのようなデータ分布で予測が弱いか」をシミュレーションやインシデント解析を通じて特定し、その分布に対してデータ収集・再学習を集中させることが重要になります。

## End-to-End Planning vs モジュラー構成

近年は End-to-End Planning（センサ入力から直接ステアリングや軌道を出力する）アプローチが注目されていますが、従来型のモジュラー構成（Perception → Prediction → Planning → Control）も依然として広く用いられています。それぞれのアーキテクチャは、データ要件・評価手法・運用のしやすさが大きく異なります。

- End-to-End アーキテクチャ:
  - 長所: モジュール間の誤差伝播を学習が吸収できる、タスク間の表現共有が進む、最終目的指標（安全性・快適性）に近い損失を設計しやすい。
  - 短所: 内部の可視性が低く、デバッグや安全認証が難しい。教師信号として「良い軌道」や「人間運転のデモ」が大量に必要。
- モジュラーアーキテクチャ:
  - 長所: 各モジュールを独立に評価・改善できる。既存の安全認証やテストフレームワークと相性が良い。
  - 短所: モジュール境界で情報が欠落したり、局所最適に陥りやすい。設計が複雑になりがち。

データ中心・Closed-Loop の観点では、End-to-End かモジュラーかを二択で考えるのではなく、「どの境界を differentiable に保つか」「どこまでを end-to-end に結合し、どこからをルールベースや安全ロジックに任せるか」を設計上の自由度として捉えることが重要です。例えば、Perception と Prediction までは End-to-End に統合し、Planning はルールベースや MPC と組み合わせるハイブリッド構成などが考えられます。

## アーキテクチャ選択とデータ要件

アーキテクチャの選択は、そのまま必要なデータの種類・量・品質に跳ね返ります。いくつか代表的なパターンを挙げます。

- BEV ベース検出モデル:
  - 必要なデータ: キャリブレーションの整ったマルチカメラ / LiDAR ログ、BEV 上の高品質なラベル（3D bounding box、occupancy grid など）。
  - 注意点: キャリブレーションドリフトやセンサ故障に弱いため、第 2〜3 章でのデータ品質管理が極めて重要。
- 世界モデル・ビデオ予測モデル:
  - 必要なデータ: 長時間連続したログ、マルチエージェントの挙動、地図や信号情報などのコンテキスト。
  - 注意点: 長期 horizon での誤差蓄積やマルチモーダル予測の評価の難しさに留意し、第 7 章の Closed-Loop 評価と連携したメトリクス設計が必要。
- End-to-End Planning モデル:
  - 必要なデータ: 人間運転のデモや既存システムの軌道、失敗ケースを含む多様なシーン。
  - 注意点: ラベルノイズ（人間運転が必ずしも最適でない）、データバイアス（安全側に倒した運転が多い）を踏まえた損失設計が重要。

Closed-Loop の観点では、アーキテクチャを選んだ後に「どのような ODD セグメントで性能が不足しやすいか」を早期に把握し、その ODD に特化したデータ収集・シナリオ設計・シミュレーションを行うことが求められます。アーキテクチャの採用前に、必要なデータ要件を明文化しておくと、後からデータ不足に気づくリスクを減らせます。

## モデルのモジュール化とインターフェース設計

自動運転モデルは、学習時には巨大なネットワークとして扱われても、デプロイ時には複数の ECU やソフトウェアコンポーネントに分割されます。そのため、アーキテクチャ設計の早い段階でインターフェースを明確にしておくことが重要です。

- 入出力の定義: 各モジュールの入力（センサデータ、BEV 特徴、予測軌道など）と出力（検出結果、リスク評価、軌道候補など）を明確にし、座標系や単位を統一する。
- 時間同期とバッファリング: パイプライン全体でのレイテンシバジェットを定め、どのモジュールがどれくらい過去の情報を参照するかを設計する。
- フォールバック経路: モデルが何らかの理由で出力できない場合に備えた fallback モード（保守的なルールベース制御など）との接続点を決めておく。

このようなインターフェース設計は、第 7 章のシミュレーション基盤や第 8 章のデプロイパイプラインとも密接に関連します。例えば、インターフェースが明確であれば、Closed-Loop シミュレーションで特定モジュールだけを差し替える A/B テスト的な検証が容易になります。

## アーキテクチャ進化のための設計指針

最後に、アーキテクチャが時とともに進化することを前提にした設計指針について述べます。

- 実験可能性 (experimentability): 新しいバックボーンやフュージョン方式、損失関数を容易に試せるように、コードベースをモジュール化し、設定ファイルで構成を切り替えられるようにする。
- 互換性 (backward compatibility): 出力インターフェースを安易に変更せず、必要に応じてバージョニングすることで、既存のシミュレーション・テスト・デプロイパイプラインへの影響を抑える。
- データ駆動な意思決定: 新しいアーキテクチャを導入する際には、必ずデータセットレベルの評価（第 6.8 節）と Closed-Loop 評価（第 7 章）を行い、メリット・デメリットを定量的に比較する。

このような設計を行うことで、アーキテクチャ変更とデータ・評価・デプロイの各ステージが整合した、健全な Closed-Loop 開発サイクルを維持しやすくなります。
