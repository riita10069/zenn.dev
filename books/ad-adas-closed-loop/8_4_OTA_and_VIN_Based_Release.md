# 8.4 OTA での配信と VIN ベースのリリース管理

この節では、OTA での配信と VIN ベースのリリース管理について解説します。地域・顧客・用途別のロールアウト戦略、フェーズドロールアウト・カナリアリリース、失敗時のリカバリパス・ロールバックを整理し、データ中心・Closed-Loop の観点から「どのバージョンのモデルがどの車両に入っているか」を把握する重要性を説明します。

## OTA 更新の基本構造

OTA (over-the-air) 更新は、車両に搭載されたソフトウェアを無線経由で更新する仕組みです。自動運転・ADAS のコンポーネントは安全クリティカルであるため、OTA の設計と運用には特に注意が必要です。一般的な OTA システムは、以下の要素から構成されます。

- バックエンドサーバ: ソフトウェアパッケージの保管、キャンペーン管理、VIN ごとの適用対象管理を行う。
- 通信インフラ: セルラー通信や Wi-Fi などを用いて車両とサーバ間の通信を確立する。
- 車両側アップデートクライアント: 更新の通知受信、ダウンロード、署名検証、インストール、ロールバック制御を行う。

更新のフローは概ね次の通りです。

1. クラウド側で更新キャンペーンを定義し、対象 VIN・ソフトウェアバージョン・スケジュールを設定する。
2. 車両がオンラインになったタイミングで、サーバから更新可能なパッケージ情報を取得する。
3. 車両側でパッケージをダウンロードし、署名検証・整合性検証を行う。
4. 条件（車両停車中、バッテリ残量など）を満たしたタイミングでインストールを実施する。
5. 更新後に自己診断・簡易機能チェックを行い、異常があればロールバックを行う。

この一連の流れは、多くの地域でソフトウェア更新に関する規制（UNECE R156 など）の対象となっており、ログの保存やユーザ通知の方法などが定められている場合があります。本書は法的アドバイスを提供するものではありませんが、OTA の設計にあたっては、必ず各地域の最新の規制やガイドラインを確認する必要があります。

## VIN ベースのリリース管理

OTA 更新において、どの車両にどのソフトウェアを配信するかは、車台番号である VIN (Vehicle Identification Number) をキーとして管理することが一般的です。VIN ベースのリリース管理では、以下の観点でのセグメンテーションが重要になります。

- 車種・グレード: 同一プラットフォームでも、センサー構成や ECU 構成が異なる場合がある。
- 地域・市場: 交通ルールや地図データ、規制要件が地域によって異なる。
- 用途・サービス種別: 個人向け乗用車、ロボタクシー、物流車両などで求められる機能が異なる。

運用上は、VIN 単位で以下の情報を管理するデータベース（フリート管理システム）が必要です。

- 現在搭載されているソフトウェア構成（ECU ごとのバージョン）
- 過去に適用された更新キャンペーンの履歴
- 車両属性（車種、センサー構成、登録地域、サービスプランなど）

8.1 節で述べたモデルレジストリ・システム構成と VIN ベース管理を連携させることで、「車両から送信されたテレメトリ（VIN, ソフトウェアバージョン）から、即座に使用中モデルの学習データや評価結果を特定する」といった Closed-Loop を実現できます。

## ロールアウト戦略：フェーズドロールアウトとカナリアリリース

自動運転機能の更新では、「すべての車両に一斉配信する」のはリスクが高く、段階的なロールアウト戦略が不可欠です。代表的な手法として、フェーズドロールアウト (phased rollout) とカナリアリリース (canary release) があります。

- フェーズドロールアウト:  
  - まず社内車両や限られた顧客グループに対して配信し、問題がないことを確認してから対象範囲を徐々に拡大する。  
  - フェーズごとに、テレメトリ・インシデント報告・ユーザフィードバックを集約し、次フェーズへ進むかを判断する。
- カナリアリリース:  
  - 特定の条件（地域、時間帯、車種など）で少数の車両を「カナリア」として選び、新バージョンを先行適用する。  
  - 旧バージョンを利用する残りの車両と比較し、安全関連指標や介入率の差分をモニタリングする。

これらの手法を実現するためには、OTA キャンペーン管理システムにおいて、

- 対象 VIN の選択条件（フィルタ）を柔軟に指定できること。
- フェーズごとの配信割合（例: 1 %, 5 %, 25 %, 100 %）とスケジュールを設定できること。
- 各フェーズで必要な観測期間や安全指標の閾値（例: 1 万 km の走行で重大インシデントゼロ）を定義できること。

が求められます。8.5 節で扱うオンラインモニタリング基盤と連携し、「フェーズ 1 の車両群の安全指標が基準を満たしたら自動的にフェーズ 2 へ進む」といった半自動化も可能です。

## 失敗時のリカバリパスとロールバック

OTA 更新には、通信失敗・電源断・ストレージ障害など、さまざまな失敗要因が存在します。これらに備えるため、OTA システムはあらかじめリカバリパスとロールバック戦略を設計しておく必要があります。8.8 節ではモデルレベルのロールバック戦略を扱いますが、ここでは OTA プロトコルレベルの観点に絞って整理します。

- デュアルバンク構成:  
  - ECU 内に「現在使用中イメージ」と「更新中イメージ」の 2 つの領域を持ち、更新は後者に対して行う。  
  - 起動時に整合性チェックを行い、問題があれば自動的に旧イメージへ戻す。
- アトミックな更新:  
  - 途中まで書き込みが行われた状態で電源断が起きても、起動時には「完全に旧バージョン」または「完全に新バージョン」のどちらかになるように設計する。
- ロールバックポリシー:  
  - 更新後に一定時間以内に重大なエラーや異常ログが検知された場合、自動的にロールバックする。  
  - ロールバックが繰り返し発生する場合は、当該 VIN を OTA キャンペーンから自動的に除外し、個別調査対象とする。

これらの挙動は、安全・法規制の観点からも重要であり、実装だけでなく仕様としても明確に定義し、テスト・監査可能な形で残しておく必要があります。

## Closed-Loop 観点での OTA 運用

OTA と VIN ベースのリリース管理は、Closed-Loop データエンジンにおいて「実世界からのフィードバックを安全に収集するための実験プラットフォーム」としても機能します。例えば、次のような運用が考えられます。

1. あるモデル改善案に対して、シミュレーションや HiL で十分な改善が確認されたものの、実世界での挙動には不確実性が残っている。
2. そのモデルを限定された VIN グループに OTA 配信し、特定の ODD セグメント（例: 都市高速・晴天昼間）に限定して有効化する。
3. 8.5 節で扱うオンラインモニタリング基盤を用いて、旧バージョンとの比較を行い、安全性・快適性・介入率などの指標を評価する。
4. 指標が期待通りに改善していれば対象 VIN を拡大し、問題があれば 8.8 節で述べるロールバックと根本原因分析に進む。

このように、OTA は単に「更新を配る仕組み」ではなく、「実世界での A/B テストやカナリア評価を安全に実施するための基盤」と捉えることができます。そのためには、OTA キャンペーン管理、VIN ベースのセグメンテーション、オンラインモニタリング、モデルレジストリを統合的に設計し、「どの車両がどのバージョンのモデルを、どの ODD で、どれくらいの距離・時間運用したか」を定量的に把握できるようにすることが重要です。

