---
title: "6.8 オフライン評価とリグレッションテスト（データセットレベル）"
---

# 6.8 オフライン評価とリグレッションテスト（データセットレベル）

この節では、オフライン評価とリグレッションテストについて解説します。Perception 指標（mAP, IoU, OSPA 等）、Prediction / Planning 向け指標（マージン、Comfort, Efficiency 等）、ODD セグメント別のスコアとレポート、第 7 章の Closed-Loop 評価との関係整理を行い、データ中心・Closed-Loop の観点から「データセットレベルでの回帰防止」を考えます。

## オフライン評価の役割

オフライン評価 (offline evaluation) は、ログやデータセットを用いてモデルの性能を定量的に測定するプロセスです。自動運転システムでは、Closed-Loop シミュレーションや実車試験だけでなく、オフライン評価がリグレッション検出やモデル比較の基盤として大きな役割を果たします。

- 高頻度で実行可能: シミュレーションや実車試験に比べてコストが低く、頻繁に実行できます。
- データセットコントロール: 特定の ODD セグメントやシナリオに絞った評価が行いやすく、データ分布を明示的に制御できます。
- 回帰検知: モデル変更やデータ更新による性能劣化（リグレッション）を早期に検出できます。

ただし、オフライン評価だけでは Closed-Loop の挙動を完全には捉えられません。そのため、第 7 章で扱うシミュレーション・ログリプレイによる Closed-Loop 評価と組み合わせて運用することが重要です。

## Perception 向け指標

Perception モジュールのオフライン評価では、一般的な物体検出・セグメンテーション指標に加えて、自動運転特有の要件を反映した指標設計が求められます。

- 検出タスク:
  - mAP (mean Average Precision): IoU スレッショルドに基づく精度の平均。
  - IoU (Intersection over Union): 予測と ground truth の重なり度合い。
  - OSPA (Optimal SubPattern Assignment): 多数の対象を扱うセット間の距離を測る指標で、誤検出・見落とし・位置誤差をまとめて扱えます。
- セグメンテーション:
  - mIoU (mean IoU)、Dice coefficient など。
- トラッキング:
  - MOTA / MOTP、ID switch 数、track fragment 数など。

自動運転においては、「少数の重大な見落とし」が安全性に大きく影響するため、平均値だけでなく、特定クラス（歩行者、自転車など）の recall や、距離レンジ別（近距離・中距離・遠距離）の検出性能を分解して評価することが重要です。

## Prediction / Planning 向け指標

Prediction / Planning モジュールのオフライン評価では、単に距離誤差を測るだけでなく、安全性・快適性・効率性などの観点を含めた指標設計が求められます。

- 予測 (prediction):
  - ADE / FDE (Average/Final Displacement Error): 予測軌道と ground truth 軌道の平均・終端位置誤差。
  - 多モーダル指標: Top-k 予測の中に ground truth が含まれるか、確率分布としての品質など。
- プランニング:
  - 安全マージン: 他車との距離、TTC (Time-To-Collision)、衝突リスク指標など。
  - 快適性 (comfort): 加速度・ジャーク（加速度変化率）、急な舵角変化など。
  - 効率性 (efficiency): 到着時間、巡航速度、停止回数など。

また、オフラインプランニング評価では、「人間運転」や既存システムを教師として、候補軌道と比較する offline RL 的な評価も行われます。Closed-Loop とのギャップを意識しつつ、少なくとも明らかな危険行動（赤信号無視、停止線オーバーなど）が発生していないかをチェックするルールベースの指標も併用されます。

## ODD セグメント別の評価とレポート

第 2 章で定義した ODD（運用設計領域）に基づき、オフライン評価結果をセグメント別に分解することが重要です。

- 時間帯: 昼・夜・薄暮。
- 天候: 晴れ・雨・雪・霧。
- 道路種別: 高速道路・都市部・郊外・住宅街。
- 交通状況: 渋滞・通常・空いている。

これらのセグメント別に mAP や ADE、各種安全指標を集計し、レポートとして可視化します。ODD セグメント別の評価により、「全体平均では改善しているが、特定の条件下では悪化している」といったパターンを早期に検知できます。

Closed-Loop の観点では、フィールドモニタリング（第 8 章）やシミュレーション（第 7 章）で観測された失敗パターンが、どの ODD セグメントに属するかを明確にし、そのセグメント向けのオフライン評価セットを手厚くする戦略が重要です。

## リグレッションテストの設計

リグレッションテスト (regression test) は、既存のモデルで達成していた性能や安全性を、新しいモデルでも維持できているかを確認するためのテストです。オフライン評価においては、代表的なシナリオを集めた固定データセットを用い、モデル更新のたびに同じテストを繰り返します。

- ゴールデンデータセット: 典型的なシーン、過去のインシデント、重要な ODD セグメントを含む固定データセットを定義し、リグレッションテストの基盤とします。
- 基準値 (baseline) と閾値: 各指標について、過去モデルの値と比較して「どの程度までの変動を許容するか」を事前に定義します。
- バリアント別評価: 車種・センサ構成・ソフトウェアバージョンごとに、必要に応じて別のリグレッションセットを用意します。

リグレッションテストは、第 8 章で扱うリリースゲートとも密接に関連します。オフライン評価が所定の閾値を満たさない場合、シミュレーションや実車試験に進ませないといったゲート設計が一般的です。

## 第 7 章の Closed-Loop 評価との関係

オフライン評価は、主に「入力データとラベルが与えられている条件下での出力品質」を測るのに対し、第 7 章で扱う Closed-Loop 評価は、「モデルが制御ループの中に入ったときの挙動」を評価します。両者の関係を整理すると、次のようになります。

- オフライン評価:
  - 長所: ラベル付きデータさえあれば大量に回せる。指標の統計的安定性が高い。
  - 短所: モデルの出力が次の入力に影響を与えないため、制御ループ内でのフィードバック効果を捉えにくい。
- Closed-Loop 評価:
  - 長所: 実際の運転タスクに近い形で挙動を評価できる。安全性や快適性を直接観測しやすい。
  - 短所: 1 シナリオあたりのコストが高く、統計的な指標を安定させるには多くの実行回数が必要。

Closed-Loop の開発サイクルでは、オフライン評価で大きな劣化がないことを確認した上で、重要シナリオについて Closed-Loop シミュレーションや実車試験を行う、という多段ゲート構成が一般的です。

## データ中心の評価とカバレッジ指標

最後に、データ中心の観点からオフライン評価とリグレッションテストを捉え直します。評価指標は単に「モデルのスコア」を測るだけでなく、「評価データセットのカバレッジ」を把握するためにも使われます。

- シナリオカバレッジ: どのようなシナリオ（例: マージ、レーンチェンジ、横断歩道、工事区間）がどれくらい含まれているかを定量化します。
- ODD カバレッジ: 各 ODD セグメントでのサンプル数と指標を集計し、偏りがないかをチェックします。
- ロングテールカバレッジ: インシデントやレアケースが、評価セット内でどの程度カバーされているかを測ります。

Closed-Loop の改善サイクルでは、評価結果をもとに「どのシナリオ・ODD セグメントで追加データ収集やラベリングが必要か」をフィードバックし、第 2〜5 章のデータパイプラインに戻します。この循環により、評価そのものも進化し続ける「データ中心の評価ループ」が形成されます。
