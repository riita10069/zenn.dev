---
title: "7.2 シナリオベーステストの考え方とシナリオ DB"
---

# 7.2 シナリオベーステストの考え方とシナリオ DB

この節では、シナリオベーステストとシナリオ DB について解説します。シナリオモデル（交通ルール、他車挙動、歩行者挙動）、OpenSCENARIO 等の DSL の位置づけ、シナリオのバージョニングと再利用を整理し、データ中心・Closed-Loop の観点から「シナリオを単位としたテスト設計」を考えます。

## シナリオとは何か：ODD とテストケースの橋渡し

シナリオ (scenario) は、ODD（運用設計領域）と具体的なテストケースの間をつなぐ概念です。一般に以下の要素から構成されます。

- 道路形状・交差点形態・信号機などのインフラ構成
- 自車両（ego vehicle）の初期位置・速度・意図（右折・進入・車線変更など）
- 他車両・歩行者・自転車・障害物などの他エージェントの初期状態と挙動モデル
- 天候・時間帯・視界条件などの環境条件
- シナリオの開始条件・終了条件、および成否判定のルール

このうち、一部のパラメータ（車速の範囲、他車の出現タイミングなど）を「論理的シナリオ (logical scenario)」として範囲指定し、その中から具体的な値をサンプリングして「具体的シナリオ (concrete scenario)」を生成する、という構造を取ることが多いです。この区別は、後述するシナリオカバレッジ設計や自動生成の観点で重要になります。

シナリオベーステストでは、「ODD 全体をカバーしたい」ではなく、「ODD を代表する重要シナリオ群を厳選し、そこに対して系統的にテストを行う」ことが目的となります。

## シナリオベーステストの目的と利点

従来の走行距離ベースの評価（○○万 km 無事故）だけでは、自動運転システムの安全性を十分に主張できないことが広く指摘されています。レアイベントや複雑な交互作用が支配的な領域では、単純な走行距離の積み上げだけでは必要なイベント頻度に到達できないためです。

シナリオベーステストの主な利点は次の通りです。

- リスクの高いシナリオにテスト資源を集中できる（効率性）。
- シナリオに紐づいた要求・安全目標とのトレーサビリティを確保しやすい。
- シミュレーション・実車・HiL のどのレベルでも同一シナリオ定義を使い回せる。
- 「何をテストしていないのか」をカバレッジ指標として定量化しやすい。

データ中心・Closed-Loop の観点では、フィールドで起きたインシデントやヒヤリハットから新たなシナリオを抽出し、シナリオ DB に追加していくことで、シナリオセット自体を継続的に進化させていくことが重要です。

## シナリオ DSL と OpenSCENARIO の位置づけ

シナリオをコンピュータで扱うためには、標準化された記述形式、すなわち DSL (domain-specific language) が必要です。自動運転・ADAS の領域では、ASAM OpenSCENARIO や OpenDRIVE などの標準が広く利用されています。

- OpenDRIVE: 道路の幾何形状・レーン構造・信号機などの静的なインフラ情報を記述するためのフォーマット。
- OpenSCENARIO: 自車と他エージェントの挙動、イベント、トリガ条件など、動的なシナリオを記述するためのフォーマット。

これらの DSL を採用することで、以下のような利点が得られます。

- シミュレータベンダーやツール間でシナリオを共有しやすい。
- テキストベースの定義により、バージョン管理（Git 等）との相性が良い。
- シナリオ生成・変換ツールを自前で開発しやすい。

一方で、標準フォーマットは表現力が高い反面、記述が冗長になりがちです。実務では、社内向けの抽象的なシナリオ記述 DSL（YAML など）を設計し、それを OpenSCENARIO などにコンパイルするパイプラインを用いることが多いです。このような二層構造を取ることで、エンジニアやテストプランナーにとって扱いやすいシナリオ定義と、ツール互換性の高いフォーマットを両立できます。

## シナリオ DB のスキーマ設計

シナリオベーステストを本格的に運用するには、シナリオ DB (scenario database) の設計が鍵となります。典型的には、以下のような情報を持つテーブル群を設計します。

- `scenarios` テーブル:
  - シナリオ ID, バージョン, 状態（ドラフト／承認／廃止）
  - シナリオ種別（合流、横断歩道、ラウンドアバウトなど）
  - 関連する安全目標 ID・要件 ID
  - ODD セグメント（地域、道路種別、天候など）
- `scenario_assets` テーブル:
  - OpenSCENARIO / OpenDRIVE ファイルへのパス
  - 関連する 3D マップ・モデル・テクスチャへの参照
- `scenario_links` テーブル:
  - 元となった実車ログの ID（該当する場合）
  - 派生したバリエーションシナリオの ID
- `scenario_metrics` テーブル:
  - 過去のテスト実行回数、成功率、検出された不具合数

このようなスキーマを設計しておくことで、「どのシナリオがどの安全目標を検証しているか」「どのシナリオが特定の ODD セグメントを代表しているか」を機械的に集計できるようになります。第 7.6 節で扱うカバレッジ設計とも密接に関係します。

## シナリオのライフサイクル管理

シナリオは一度作れば終わりではなく、以下のようなライフサイクルを辿ることが多いです。

1. 企画・安全チーム・開発チームが協議し、リスクの高い領域や重要なユースケースを洗い出す。
2. フィールドからのインシデントやヒヤリハット、解析結果から具体的なシナリオ候補を抽出する。
3. シナリオプランナーが DSL を用いて論理的シナリオを定義し、レビュー・承認を受ける。
4. 自動・半自動ツールで具体的シナリオを生成し、シミュレーションや HiL で実行する。
5. テスト結果に基づき、シナリオの難易度調整やバリエーション追加、廃止などを行う。

データ中心・Closed-Loop の観点では、このライフサイクルを単にドキュメントで回すのではなく、シナリオ DB と評価基盤を通じて半自動化することが重要です。例えば、フリートから新たな危険パターンが検出された場合、自動的に類似シナリオが生成され、レビュー待ちの状態でシナリオ DB に登録される、といったフローが考えられます。

## シナリオ単位での Closed-Loop

最後に、シナリオベーステストが Closed-Loop データエンジンにどのように組み込まれるかを整理します。典型的には、以下のようなループが構成されます。

1. シナリオ DB に登録されたシナリオに対して、SiL / HiL / 実車テストを定期的に実行する。
2. 成功率・安全マージン・ログ解析結果をシナリオ単位で集計し、ダッシュボードで可視化する。
3. 成績の悪いシナリオに対して、元データの追加収集・再ラベリング・モデル改良を行う（第 4〜6 章）。
4. 改良版モデルを再度同じシナリオセットで評価し、改善度合いを確認する。

このように、シナリオを単位としたテスト設計は、単なるテストの自動化にとどまらず、データ中心・Closed-Loop の「座標系」として機能します。本書を通じて、読者のみなさんが自組織のシナリオ DB を核にした改善サイクルを設計・運用できるようになることを目指します。
