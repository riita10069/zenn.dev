# 5.1 ラベリングポリシーと定義書の作り方

この節では、ラベリングポリシー (labeling policy) と定義書 (guideline) の作り方について解説します。オブジェクトクラス・属性・シナリオタグのタクソノミ、境界ケースの定義、ラベルポリシー変更のバージョニングなどを整理し、データ中心・Closed-Loop の観点から「一貫したラベルがモデル品質の土台である」ことを説明します。

## オブジェクトクラス・属性・シナリオタグのタクソノミ

自動運転では、車両・歩行者・自転車といった基本クラスに加えて、駐車車両、緊急車両、特殊車両、交差点の種類、優先関係など、多様な属性やシナリオタグを扱います。これらを体系的なタクソノミ (taxonomy) として整理し、定義書として文書化することが重要です。

- オブジェクトクラス: 車種、歩行者、二輪車、動物、固定障害物など。
- 属性: 信号状態、右折／左折、ブレーキランプ点灯、ウィンカー、車線種別など。
- シナリオタグ: 合流、追い越し、右折、横断歩道、工事区間など。

## 境界ケースの定義と例示

現実のシーンでは、「どちらとも解釈できる」境界ケースが多く存在します。例えば、停止中の歩行者が「歩行者」としてラベルされるか、「スタンディング」といった別クラスか、路上駐車車両と車線外駐車の違いなどです。これらについて、定義書で明確なルールと具体例を示し、アノテータ間のばらつきを減らすことが重要です。

Closed-Loop の観点では、モデルのエラー分析から得られた境界ケースを定義書に取り込み、継続的にアップデートしていくことが求められます。

## ラベルポリシー変更のバージョニング

ラベルポリシーは一度決めて終わりではなく、開発の進展やユースケースの変化に応じて進化していきます。その際、ポリシー変更のバージョニングと、それに伴う再ラベリング戦略を設計することが重要です。

## タクソノミ設計の実務的ステップ

オブジェクトクラスや属性・シナリオタグのタクソノミは、「どのタスクでどの指標を改善したいか」から逆算して設計することが多いです。自動運転向け公開データセット（例: Cityscapes、nuScenes、Waymo Open Dataset など）でも、検出 (object detection)、セマンティックセグメンテーション (semantic segmentation)、トラッキング (multi-object tracking) などのタスクごとにラベルセットが設計されています。

実務では次のようなステップでタクソノミを詰めていくと整理しやすいです。

1. **対象タスクと指標の整理**  
   例として、歩行者検出の Precision/Recall、車線維持の車線検出 IoU、シーンレベルのリスクスコアなど、モデル側で計測するメトリクスを列挙します。これにより、どのクラス・属性が本当に意思決定に寄与しているかが明確になります。
2. **既存タクソノミの再利用**  
   公開データセットや既存社内プロジェクトのラベルセットを収集し、「必須クラス」「Nice-to-have クラス」「実務上ほぼ使われていないクラス」に分類します。Cityscapes のように 30 クラスを 19 クラスにマージして評価している事例からも分かるように、評価用のクラスとアノテーション用のクラスを分ける設計も有効です。
3. **階層構造 (hierarchy) の定義**  
   上位レベルに「動的物体 (dynamic actor)」「静的構造物 (static structure)」「交通制御 (traffic control device)」「路面属性 (road surface)」「環境要因 (environment)」などのカテゴリを置き、その下に具体的なクラス（乗用車 / トラック / バス / 自転車 / バイク / 歩行者 …）をぶら下げます。タスクによっては上位カテゴリだけを扱い、詳細クラスは属性として扱うほうがシンプルになります。
4. **属性 (attribute) 設計**  
   クラスとは別に、「移動状態 (moving/parked/stopped)」「信号状態 (red/yellow/green)」「ライト点灯」「天候」「明るさ (day/night)」などを属性として定義し、必要に応じてマルチラベルにします。nuScenes のように、`category_name` と `attribute` を分離して管理する設計は、ポリシー変更や集計の柔軟性が高いです。
5. **シナリオタグ (scenario tag) 設計**  
   シーン単位で付与するタグとして、道路種別（高速道路 / 一般道 / 住宅街）、交差点種別（ラウンドアバウト / T 字路 / 十字路）、イベント（合流 / 追い越し / U ターン / 渋滞末尾追突）、環境（雨 / 雪 / トンネル / 工事区間）などを定義します。これらはモデル入力に直接は使わない場合でも、データ探索やカバレッジ分析に不可欠です。

Closed-Loop の観点では、このタクソノミは一度決めて終わりではなく、誤認識やヒヤリハット分析の結果に応じて継続的に改訂されます。したがって、初期段階から「将来の変更を前提とした拡張余地」を残すことが重要です。

## 境界ケースのルール例とドキュメント化

多くの公開ガイドラインでは、境界ケースに対してかなり詳細なルールを設けています。いくつか典型的なルールパターンを示します。

- **部分的に見えている物体 (occluded / truncated)**  
  物体の一部しか見えていない場合でも、「一定以上のサイズが見えている」「将来のフレームで完全に見える」といった条件を満たすならラベルを付与する、というルールが多いです。Cityscapes や nuScenes でも、オクルージョン状態をラベルで持ちつつ、検出対象から除外しない方針が採用されています。
- **駐車車両 vs 走行車両**  
  「数秒以上速度ゼロで、かつウィンカーやブレーキランプが点灯していない車両は駐車 (parked) とみなす」といった時間的条件をポリシーに明記します。Prediction タスクでは、この属性が将来軌跡予測の前提となります。
- **歩行者 vs 作業者 vs 二輪車搭乗者**  
  路上で立ち止まりつつ看板作業をしている人、キックボードを押している人などは、データセットごとに扱いが異なります。「人が乗っていれば vehicle + rider とする」「押している場合は pedestrian とする」といったルールを、絵付きの例で示すとアノテータが迷いにくくなります。
- **合流・優先関係シナリオ**  
  車線減少や合流部では、「どちらの車線に所属する車両か」「どの車両に優先権があるか」が曖昧になりがちです。TAS500 のような高精度マップ付きデータセットでは、レーンポリラインとの位置関係から自動的に優先関係を推定し、アノテータが修正するワークフローを採用している例もあります。

定義書には、上記のようなルールを文章だけでなく、実際のスナップショット画像・シーン動画とセットで掲載することが望ましいです。モデルのエラー分析で新たな境界ケースが見つかった際には、その例を定義書に追記し、アノテータ教育とツール内のチュートリアルに反映します。

## ラベルポリシーのバージョニングと互換性管理

ラベルポリシーを継続的に改善するには、ポリシーとデータセットのバージョニングを明示的に管理する必要があります。典型的には、次のような要素を設計します。

- **スキーマバージョン (label_schema_version)**  
  クラス・属性・タグの定義が変わるたびにスキーマのバージョンをインクリメントし、データセットメタデータに保存します。`v1.2.0` のように semantic versioning を採用し、「メジャーバージョンアップ時は後方互換性が壊れる」ことを明示する運用も有効です。
- **変更ログ (change log)**  
  「クラス A を B と C に分割」「属性 `is_parking` を廃止し、`motion_state` に統合」などの変更を、人間が読める形で履歴に残します。学習・評価コードから参照できるように、機械可読な JSON や YAML でも管理しておくと便利です。
- **マッピングルール (label mapping)**  
  既存データセットを新スキーマに移行する際は、旧ラベルから新ラベルへのマッピングテーブルを用意します。例えば `car` / `truck` / `bus` を統合して `vehicle` として扱う、逆に `vehicle` を分割する、といった操作に対して、どのような変換を行ったかをコード化しておきます。
- **評価指標への影響評価**  
  ポリシー変更によって、過去のモデル評価結果との比較が困難になることがあります。そのため、「旧スキーマでの評価」「新スキーマでの評価」を併記する移行期間を設けることが多いです。

Closed-Loop の全体像で見ると、ラベルポリシーの変更は「エラー分析 → ポリシー改善 → ラベリング・再ラベル → 再学習 → 再評価」というループの起点になります。スキーマバージョンとマッピングルールが整備されていると、このループを壊さずに素早く回せるようになり、データ中心の開発文化が根付きやすくなります。
