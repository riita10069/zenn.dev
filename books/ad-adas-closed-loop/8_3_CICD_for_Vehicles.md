---
title: "8.3 実車向け CI/CD パイプライン"
---

# 8.3 実車向け CI/CD パイプライン

この節では、実車向け CI/CD パイプラインについて解説します。ビルド・コンパイル・パッケージング・署名、車両バリエーション（ECU・センサー構成）への対応、Staging 車両・社内フリートでの段階的展開を整理し、データ中心・Closed-Loop の観点から「ソフトウェア変更と評価データの紐付け」を考えます。

## 車載ソフトウェア向け CI/CD の特徴

クラウドサービス向けの CI/CD と比較した場合、車載ソフトウェア・自動運転スタック向け CI/CD にはいくつか固有の特徴があります。

- ハードウェア依存性が高く、ターゲット ECU ごとにコンパイル・リンク・最適化条件が異なる。
- ソフトウェア更新が安全性・法規制に直結し、誤ったリリースが重大事故に繋がり得る。
- OTA 更新に失敗した場合のリカバリが容易ではなく、ロールバック戦略を含めた慎重な運用が必要。
- 実車試験や HiL、シミュレータなど、物理リソースを伴うテストステージがパイプラインに組み込まれる。

このため、単に「コードが main ブランチにマージされたらすぐに本番反映する」という典型的な Web の Continuous Deployment とは異なり、多くの場合は「CI で自動テストを最大限実行しつつ、最後は明示的なリリース承認を伴う Continuous Delivery」として設計されます。

## ビルド・コンパイル・パッケージング

実車向け CI/CD のパイプラインは、大まかに次のステージで構成されます。

1. ソースコードの取得・依存関係の解決  
   - Git リポジトリからのチェックアウト、サブモジュール解決。  
   - 依存ライブラリのバージョンロック（lockfile、コンテナイメージなど）。
2. ビルド・コンパイル  
   - ターゲット OS（Linux, QNX など）やアーキテクチャ（ARM, x86）向けのクロスコンパイル。  
   - 解析・最適化オプション（コンパイラ最適化、LTO、シンボル削減など）の適用。  
   - CUDA や各種アクセラレータ向けのビルド。
3. モデル組み込み  
   - 第 6 章で作成した学習済みモデルを、推論エンジン（TensorRT, ONNX Runtime など）向けに変換。  
   - 8.1 節で扱ったモデルレジストリから必要なバージョンを取得し、アプリケーションに組み込む。
4. パッケージング  
   - ECU ごとのイメージ（ファームウェアイメージ、コンテナイメージなど）を生成。  
   - 車両全体のシステム構成ファイル（どの ECU にどのバージョンが載るか）を生成。

これらのステージは、一般的な CI ツール（GitHub Actions, GitLab CI, Jenkins など）と組み合わせて自動化できますが、自動運転の場合はビルド時間が長くなりがちです。そのため、インクリメンタルビルドやキャッシュの活用、モデル変換ステージの切り出しなど、パイプライン効率化の工夫が重要になります。

## 署名・セキュリティとリリースアーティファクト

安全性・セキュリティの観点から、車載ソフトウェアの CI/CD では「署名 (code signing)」と「アーティファクトの完全性保証」が必須となります。

- 生成されたバイナリやイメージに対して、組織が管理する秘密鍵で電子署名を行う。
- 署名時点のビルドメタデータ（Git コミット ID、モデルバージョン、ビルド環境など）をレジストリに記録する。
- OTA サーバや車両側は、署名検証に失敗したイメージを一切受け付けない。

CI/CD パイプラインには、「署名用のステージ」と「署名済みアーティファクトの保管場所（アーティファクトリポジトリ）」を明確に分離することが望ましいです。署名鍵の取り扱いはセキュリティ上のクリティカルな部分であり、多くの組織では専用の署名サーバや HSM (Hardware Security Module) を用いて厳格に管理します。

データ中心・Closed-Loop の観点では、署名済みアーティファクトにもメタデータとして「どのモデルとデータセットに由来するか」を埋め込みます。例えば、

- イメージのメタデータとして、`model_version`, `training_dataset_id`, `simulation_suite_id` などを持たせる。
- それらをモデルレジストリ・実験管理システムと双方向にリンクさせる。

ことで、「車両から送信されたテレメトリ（ソフトウェアバージョン情報）から、即座に対応する学習データや評価結果にアクセスできる」状態を実現できます。

## 車両バリエーションと構成管理

量産車両やサービスフリートでは、車種・センサー構成・地域（マーケット）によって多くのバリエーションが存在します。例えば、

- センサー構成が異なる派生車種（カメラ台数・配置、LiDAR の有無など）
- 国・地域ごとに異なる交通ルールや地図データ
- 顧客グレードやサービスプランによる機能差（L2 / L3 の切り分けなど）

これらを CI/CD パイプラインに組み込むには、構成管理 (configuration management) を第一級の概念として扱う必要があります。具体的には、

- 「車両ファミリ」「ECU タイプ」「センサー構成」「地域」といった軸で構成テンプレートを定義する。
- 各テンプレートに対して、ビルド・パッケージング・テストのバリエーションが自動的に生成されるようにする。
- VIN ベースのリリース管理（8.4 節）と連携し、「どの VIN にどの構成のイメージが適用されるか」を明示する。

このとき、「構成の組み合わせ爆発」とどう向き合うかが実務上の課題になります。すべての組み合わせをフルテストするのは現実的ではないため、

- 安全クリティカルな部分に関わる構成の違いを優先してテストする。
- 共通コンポーネントについては代表構成でテストし、他構成への影響を分析的に評価する。

といったリスクベースのアプローチが重要になります。

## ステージング車両と段階的展開を組み込んだパイプライン

実車向け CI/CD では、パイプラインの終端が「本番フリート」ではなく、「ステージング車両 → 限定フリート → 本番フリート」という階層構造になることが多いです。これをパイプライン上で明示的に表現すると、以下のようなステージを持つことになります。

1. `staging` ステージ  
   - 社内テスト車両や試験場での評価向けに、最新の開発ブランチを高頻度でデプロイ。  
   - 新機能の試験や探索的テストに利用するため、ゲート条件は比較的緩く設定。
2. `pre-production` ステージ  
   - サービス本番環境に近い条件での運用試験。  
   - 第 8.2 節で定義したリリースゲートをほぼすべて適用し、残りは運用チームの最終判断に委ねる。
3. `production` ステージ  
   - 顧客車両・商用サービス車両への展開。  
   - 追加の承認フロー（安全担当・法務など）を経て、VIN 単位で OTA を制御。

CI/CD ツール上では、これらのステージを個別のジョブや環境として定義し、それぞれに対して

- 実行可能なユーザ（誰がどのステージまでデプロイできるか）
- 適用されるゲート・テストスイート
- 必要な承認者（マルチサイン）

を設定します。これにより、「開発者はステージング車両までは自律的にデプロイできるが、本番フリートへのデプロイには安全担当の承認が必須」といった現実的な権限分離を実現できます。

## データ中心・Closed-Loop との接続

実車向け CI/CD パイプラインをデータ中心・Closed-Loop の観点から見ると、「ソフトウェア変更とデータ・評価結果のトレーサビリティを保つ仕組み」と言い換えられます。具体的には、

- 各ビルド・デプロイジョブが、対応するモデルバージョン・データセット・シミュレーションスイートの ID をメタデータとして記録する。
- デプロイ結果（どの VIN にどのバージョンがいつ配信されたか）をテレメトリ基盤に送信し、8.5 節で扱うオンラインモニタリングと連携する。
- インシデント発生時に、CI/CD ログ・モデルレジストリ・データセット管理システムを結んだ「一気通貫のトレース」を実現する。

といった設計が重要です。これにより、「このインシデントは、どのリリースで導入されたどのモデル変更に起因するのか」「その変更はどのデータセットと評価結果に基づいて承認されたのか」を迅速に特定でき、再発防止のためのデータ収集・再学習・ゲート強化へとスムーズにつなげることができます。

