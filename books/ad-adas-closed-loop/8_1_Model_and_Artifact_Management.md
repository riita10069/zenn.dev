# 8.1 モデル管理とアーティファクト管理

この節では、モデル管理とアーティファクト管理について解説します。モデルレジストリ（学習済みモデル・コンパイル済みバイナリ・設定）、データセット・実験・モデルバージョンのリンクを整理し、データ中心・Closed-Loop の観点から「どのモデルがどのデータと評価結果に基づいて展開されているか」を追跡する重要性を説明します。

## モデルとアーティファクトのスコープ定義

まず、「モデル」と「アーティファクト (artifact)」のスコープを明確にしておくことが重要です。自動運転や ADAS の場合、単一のニューラルネットワークだけでなく、以下のような要素をすべて含めてモデルとみなすことが多いです。

- 学習済みパラメータ（ニューラルネットワークの重み）
- 前処理・後処理ロジック（正規化、座標変換、NMS など）のコード
- 推論グラフに変換された中間表現（ONNX, TensorRT Engine など）
- ECU ごと・車種ごとの設定値（閾値、ゲイン、速度制限などの calibration data）
- HD マップやシーンプリオリティテーブルなどの外部依存データ

これらをまとめて 1 つの「モデルバージョン」として扱うか、コンポーネントごとに分割するかは組織ごとに異なりますが、少なくとも「車両にデプロイされる単位」と「評価・実験で扱う単位」は明示的に決めておく必要があります。データ中心・Closed-Loop の観点では、「どのインシデントがどのモデルバージョン（および関連データセット）に紐づくか」をあとから追跡できることが重要になるためです。

## モデルレジストリの基本構造

モデルレジストリ (model registry) は、モデルバージョンを一元管理するためのデータベースと UI／API の組です。一般的には以下のようなエンティティを持ちます。

- モデルファミリ（例: `perception_front_camera`, `prediction_lane_change` など）
- モデルバージョン（例: `v1.3.5` や Git の SHA と紐付いた ID）
- ステージまたはライフサイクル（`Development`, `Staging`, `Production` など）
- メタデータ（作成者、作成日時、トレーニング環境、関連チケット）
- リンク情報（使用したデータセット ID、実験 ID、評価レポート ID など）

実装としては MLflow Model Registry のような専用ツールを用いる場合もあれば、自社の実験管理システムやデータカタログの一部として実装する場合もあります。どのような実装を選ぶにせよ、「人間が名称だけを見て意味を推測する」のではなく、「レジストリからメタデータを取得すれば、どのような条件で学習・評価されたモデルかが機械的にわかる」状態を目指すことが重要です。

データ中心の開発では、モデルレジストリは単なるファイル置き場ではなく、「Closed-Loop データエンジンのハブ」として機能します。たとえば、インシデント分析の結果として「特定のモデルバージョンが特定 ODD の一部で性能不足」と判明した場合、モデルレジストリを起点に、

- そのモデルが学習されたデータセットのバージョン
- そのデータセットがどの走行ログ・ラベルから構成されているか
- 学習・評価時にどのハイパーパラメータやコードバージョンが使われたか

を辿れることが、根本原因分析 (root cause analysis) と再学習計画の立案に直結します。

## データセット・実験・モデルバージョンのリンク

Closed-Loop 開発では、「データセット → 実験 → モデル → 評価結果 → デプロイメント」という鎖が明示的に管理されていることが望ましいです。この鎖を実現するため、モデルレジストリのスキーマ設計では少なくとも以下のリンクを持たせます。

- `training_dataset_id`: 学習に使用したデータセットの ID
- `validation_dataset_id` / `test_dataset_id`: オフライン評価に使用したデータセットの ID
- `experiment_id`: 実験トラッキングシステム上の実験 ID
- `code_commit_id`: 学習・推論コードの Git コミット ID
- `simulation_suite_id` / `hil_suite_id`: シミュレーション・HiL で使用したテストスイート ID
- `release_gate_result_id`: 8.2 節で扱うリリースゲート評価の結果 ID

これらを単なる文字列タグとして保存するだけでなく、別システムのエンティティと相互参照できるように API レベルで連携しておくと、後述するインシデントからのフィードバックサイクルを自動化しやすくなります。

例えば、インシデント管理システムで「モデルバージョン X に起因すると推定されるヒヤリハット」が登録されたとき、

1. モデルレジストリから `training_dataset_id` を取得する。
2. データセット管理システムから当該データセットのカバレッジ（ODD セグメント別の分布）を確認する。
3. 不足しているセグメントに対して、4 章で扱ったデータ選択・追加収集を行う。

といった一連の操作をスクリプトやワークフローエンジンで自動化できます。これが「モデル管理とデータ管理が分断されていない状態」であり、Closed-Loop データエンジンを実現するための前提条件になります。

## 複数コンポーネント・複数 ECU の管理

自動運転スタックでは、単一のモデルではなく、多数のコンポーネントが組み合わさって 1 つの機能を構成しています。例えば、前方カメラ向けの車線検出モデル、Radar-LiDAR 融合のオブジェクト検出モデル、軌道生成モデル、行動決定ロジックなどが別々の開発・リリースサイクルを持つことがあります。

このような環境では、

- コンポーネントごとに独立したモデルレジストリを持つ
- それらを束ねる「システム構成 (system configuration)」のエンティティを別途管理する

という二層構造で管理するのが一般的です。システム構成には、以下のような情報を含めます。

- 各 ECU に搭載されるソフトウェアバージョン
- 各 ECU 内で使用されるモデルバージョン（例: `perception_front_camera v1.3.5`）
- 共有ライブラリやミドルウェアのバージョン（ROS, DDS, OS, コンパイラなど）
- 車種・センサー構成・地域（マーケット）に応じたパラメータセット

OTA 配信や HiL 評価では、このシステム構成単位でパッケージング・検証を行うことが多いため、モデルレジストリと構成管理システム（いわゆる構成管理データベース; CMDB）を連携させることが重要です。具体的には、「VIN X の車両にはシステム構成 Y が搭載されており、その中の perception モデルはバージョン v1.3.5 である」といった関係を機械的に復元できるようにしておきます。

## セキュリティ・コンプライアンスとアーティファクト

実車に搭載されるアーティファクトは、安全性だけでなくセキュリティや規制遵守の観点でも管理する必要があります。特に、

- すべてのバイナリ・モデルファイルに対する署名 (code signing)
- SBOM (Software Bill of Materials) やライセンス情報の管理
- 暗号鍵・証明書類のローテーションと保管ポリシー

といった項目は、モデルレジストリ単体ではなく、ソフトウェア構成管理やセキュリティ管理システムと連携して扱うことが望ましいです。モデルファイルはしばしば暗号化されて ECU 内に格納されるため、「署名・暗号化前のアーティファクト」と「署名・暗号化後の配布用アーティファクト」の両方を追跡できる構造にしておくと、インシデント調査や規制当局への報告時に役立ちます。

データ中心・Closed-Loop の観点では、セキュリティインシデントやソフトウェア更新の履歴もまた「データ」として扱います。例えば、特定のセキュリティ更新後にモデルのリアルタイム性能が悪化した場合、その更新に含まれる変更内容とモデルバージョンとの関係をレジストリから遡れることが重要です。

## Closed-Loop データエンジンにおけるモデル管理の役割

最後に、Closed-Loop データエンジン全体の中でモデル管理が果たす役割を整理します。第 1 章で述べたように、Closed-Loop の 7 段階は

1. データ収集
2. データ保存・インジェスト
3. データ選択・前処理・データセット設計
4. データラベリング・オートラベリング
5. モデル学習・オフライン評価
6. シミュレーション / テスト検証（Closed-Loop 評価）
7. 実世界展開・オンライン評価・フィードバック

という流れで構成されます。モデルレジストリとアーティファクト管理は、特に 5〜7 の段階を横断する「骨格」として機能します。

- 5 の段階では、学習ジョブが生成したモデルとメタデータをレジストリに登録し、どのデータセットからどのようなモデルが得られたかを記録します。
- 6 の段階では、シミュレーションや HiL で評価するモデルをレジストリから取得し、評価結果を再びレジストリや関連システムにリンクします。
- 7 の段階では、デプロイされたモデルバージョンごとにオンラインモニタリング結果やインシデント情報を紐づけ、次のデータ選択・再学習に活用します。

このように、モデル管理とアーティファクト管理は「Closed-Loop をデータの流れとして閉じる」ための接着剤の役割を果たします。単に「最新版のモデルを配る」だけでなく、「どのモデルがどのデータに基づいて、どのような評価を経て、どの車両に展開されているか」を一貫して追跡できる仕組みを整えることが、第 8 章以降の実世界展開戦略の土台となります。

