# 6.1 実験管理：データセット／ハイパラ／結果のメタデータ管理

この節では、AD モデル学習における実験管理 (experiment management) について解説します。実験トラッキングツール（例: MLflow 的なもの）の活用、データセット・ハイパーパラメータ・コードバージョン・結果メトリクスのメタデータ管理、再現性の確保を整理し、データ中心・Closed-Loop の観点から「どの実験がどのデータに基づいて行われたか」を追跡する重要性を説明します。

## 実験管理が満たすべき要件

自動運転 (autonomous driving) モデルの実験管理は、一般的な ML システム以上に強い要求を満たす必要があります。具体的には、以下の観点が重要になります。

- 再現性 (reproducibility): 数か月後でも、同じデータ・コード・ハイパーパラメータ・環境で同一結果を再現できること。
- 追跡可能性 (traceability): どのモデルがどのデータセットと実験設定に基づいて学習されたのかを、監査的観点で説明できること。
- 関連性 (provenance linkage): インシデントやシミュレーション結果から、元になったトレーニングデータやモデルバージョンを辿れること。
- スケーラビリティ (scalability): 毎日多数の実験ジョブが走る環境でも管理が破綻しないこと。

Closed-Loop の観点では、「インシデント → データセット更新 → 再学習 → 評価 → デプロイ」というループを繰り返したときに、それぞれのループのステップがどの実験・どのデータと結びついていたかを、後から確実に追跡できることが求められます。

## 実験トラッキングツールの活用

実験管理の中核は、実験トラッキングツール (experiment tracking tool) によるメタデータ管理です。代表的な OSS としては MLflow、Weights & Biases (W&B)、Neptune などがあり、多くの組織で類似の仕組みが構築されています。これらのツールはおおよそ以下の機能を提供します。

- 実験 Run の単位でハイパーパラメータ・メトリクス・ログ・アーティファクトを記録する。
- データセット ID やコードバージョン (Git commit hash) をタグやパラメータとして紐づける。
- ダッシュボード上で複数 Run の比較・フィルタリング・検索を行う。

自動運転開発においては、これらに加えて以下のような要件も考慮することが多いです。

- ODD セグメント (時間帯・天候・道路種別など) のカバレッジ情報を実験に紐づける。
- データ選択ポリシー（例: インシデント由来データ 20%、ランダムサンプリング 80%）を明示したタグを残す。
- シミュレーション結果やログリプレイ結果とリンクするためのシナリオ ID・ケース ID を保存する。

実装レベルでは、学習スクリプトのエントリポイントで実験トラッキングの初期化を行い、学習ループの中でメトリクスを記録します。

```python
import mlflow

mlflow.set_experiment("ad_perception_bev")
with mlflow.start_run():
    mlflow.log_param("dataset_version", "v2025.03_incident_mix")
    mlflow.log_param("backbone", "resnet50")
    mlflow.log_param("lr", 1e-4)
    # 学習ループ…
    mlflow.log_metric("val_mAP", val_map)
```

上記のようなコードをすべてのトレーニングジョブに共通化することで、後から「特定のデータセットバージョンとハイパーパラメータ集合で学習された Run」を一括検索しやすくなります。

## データセット・コード・ハイパーパラメータのバージョニング

実験の再現には、データセット、コード、ハイパーパラメータ、実行環境の 4 つをバージョニングし、相互にリンクさせる必要があります。

- データセット: データレイクや DVC / lakeFS のようなデータバージョニングツールで、スナップショット ID を付与します。
- コード: Git リポジトリの commit hash またはタグでバージョンを表現します。
- ハイパーパラメータ: YAML などの設定ファイルと、そのハッシュ値を実験メタデータに記録します。
- 実行環境: コンテナイメージ (Docker image) のタグ、CUDA / ドライババージョン、ライブラリバージョンを含めて記録します。

実験トラッキングのテーブル設計では、最低限以下の項目を持つとよいです。

- `experiment_id`: 実験の論理名（例: `bev_det_v2`）
- `run_id`: 個々の Run を区別する ID
- `dataset_version_id`: データセットのスナップショット ID
- `code_version`: Git commit hash
- `config_hash`: ハイパーパラメータ設定ファイルのハッシュ
- `docker_image`: 実行コンテナイメージ
- `metrics`: mAP や loss 値などの主要指標

Closed-Loop の観点では、データセットバージョンが「どのインシデント群から生成されたか」や、「どの ODD セグメントのデータを含むか」といったメタデータも同時に管理し、実験とのリンクを張ることが重要です。これにより、インシデント解析の結果から「どのループでどのような改善施策を打ったか」を後から振り返ることができます。

## 再現性を担保するための運用ルール

実験管理はツールを導入するだけでは不十分で、運用ルールを明文化し、チーム全体で遵守することが求められます。代表的なルールの例を挙げます。

- すべての学習ジョブは experiment tracking に登録し、ローカル実行の「お試し」も含めて可視化する。
- すべての公式評価結果（リリース判定に用いるもの）は、固定されたデータセットバージョンに対する Run に限定する。
- 乱数シード (random seed) を明示的に固定し、学習の非決定性をログに残す。
- 実験ノート (experiment note) として、実験の意図・観察点・次のアクションを残す。

特に自動運転では、安全性や法令上の説明責任があるため、「なぜこのモデルを採用したのか」「どのようなデータで評価し、どの程度改善したのか」をドキュメントとして説明できることが重要になります。そのため、実験トラッキングと文書管理を組み合わせた運用（Confluence / Notion 的な Wiki とリンクさせるなど）が有効です。

## Closed-Loop での実験管理パターン

Closed-Loop の開発サイクルでは、インシデントやオフライン評価結果から特定の失敗モードが見つかり、それを起点に新しいデータセットを作成し、再学習・再評価を行います。このループを実験管理の観点から整理すると、以下のようなパターンになります。

1. 失敗シナリオの特定: オフライン評価やシミュレーション、第 8 章で扱うフィールドモニタリングから、特定のケース（例: 夜間の逆光交差点での見落とし）を特定します。
2. データセット更新: 第 4 章・第 5 章で扱ったデータ選択・ラベリングパイプラインを通じて、該当ケースを含むデータセットバージョン `v_next` を作成します。
3. 実験定義: 「`v_prev` → `v_next` のデータ差分を用いた再学習」という実験を、experiment tracking 上で新しい experiment として定義します。
4. 学習・評価: 学習ジョブとオフライン評価ジョブを実行し、mAP や ODD セグメント別指標の改善状況を記録します。
5. デプロイと監視: 第 8 章で扱うデプロイ・モニタリングパイプラインに渡し、本番での挙動を観察します。

この一連のループを継続的に回すためには、「データセットバージョン」「実験」「モデル」「評価レポート」がすべてリンクされた一貫したメタデータモデルを設計することが不可欠です。

## チーム横断でのメタデータ設計

実験管理のメタデータは、研究チームだけでなく、DataOps、MLOps、シミュレーションチーム、フィールド運用チームなど、複数の職種が利用します。そのため、初期段階から以下のような観点でスキーマを設計しておくと、後々の拡張がしやすくなります。

- 役割ごとのビュー: 研究者向けにはモデルアーキテクチャや学習曲線、データエンジニア向けにはデータ出所や品質指標、マネージャ向けには KPI・リリース決定状況が見えるビューを用意する。
- タクソノミの共通化: ODD セグメント、シナリオタグ、ラベルポリシーバージョンなどのタクソノミを第 2〜5 章と共通の辞書で管理する。
- ID 設計: 実験 ID、モデル ID、データセット ID、シナリオ ID を規則的に設計し、人間にも機械にも扱いやすくする。

このようなメタデータ設計を行うことで、Closed-Loop 全体の可観測性 (observability) が高まり、どの改善サイクルがどの程度の効果を持ったのかを定量的に把握しやすくなります。
