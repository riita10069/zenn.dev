---
title: "1.2 自動運転スタックの全体像と ML タスクの位置づけ"
---

# 1.2 自動運転スタックの全体像と ML タスクの位置づけ

この節では、自動運転スタック (autonomous driving stack) の典型的な構成要素を俯瞰し、各モジュールがどのような機械学習 (machine learning) タスクとデータに依存しているかを整理します。カメラや LiDAR といったセンサーから制御コマンドに至るまでの情報の流れを追うことで、「どこでどのようなデータが生まれ、どこで消費されるのか」を理解することが目的です。また、閉ループ (closed-loop) なデータエンジンを設計する際に、どのレイヤーからフィードバック信号を取得できるかを考える土台を作ります。

## 自動運転スタックの基本構成

典型的な自動運転システムは、以下のようなモジュール群から構成されます。

- センシング (sensing): Camera, LiDAR, Radar, GNSS, IMU などのセンサーにより、車両周辺および自車状態を計測します。
- 知覚 (perception): センサー入力から物体検出、セマンティックセグメンテーション、レーン検出などを行い、環境を構造化された表現に変換します。
- 予測 (prediction): 周囲の車両や歩行者、自転車などの将来軌道や行動意図を推定します。
- 経路計画・行動決定 (planning / behavior): ゴールまでの経路を計画し、短期的なモーションプラン (motion plan) を生成します。
- 制御 (control): モーションプランに基づき、ステアリング・アクセル・ブレーキなどの車両アクチュエータを制御します。

これらに加え、多くのシステムでは以下のような補助モジュールが存在します。

- ローカライゼーション (localization): GNSS、IMU、ホイールエンコーダ、マップ情報を統合し、自車位置と姿勢を高精度に推定します。
- HD マップ (high-definition map): 車線境界、停止線、信号機位置、勾配などの静的情報を提供します。
- V2X 通信 (vehicle-to-everything): 他車両やインフラからの情報を受信し、認識の補完や先読み安全に活用します。

このようなスタックは、モジュラー構成 (modular architecture) として各コンポーネントが明確なインターフェースでつながっている場合もあれば、End-to-End モデルの内部に暗黙的に埋め込まれている場合もあります。どちらの形態であっても、実世界からのデータを取り込み、内部表現を経由して制御出力を生成するという大枠は共通です。

歴史的には、Google/Waymo や Uber ATG、オープンソースの Autoware / Apollo などが公開しているアーキテクチャ図を見ると、多くのシステムがここで挙げたようなモジュール群を持ちつつ、プロジェクトごとにモジュール分割の粒度やインターフェースの設計が異なることがわかります。また、近年の End-to-End ドライビングの研究では、これらのモジュール境界をニューラルネットワーク内部に取り込んだ「暗黙的スタック」を構成する試みも増えていますが、センサーから制御までの情報流れという観点では、本質的な要素は同じであると考えられます。

データ中心・Closed-Loop の観点では、「スタックをどのように分割するか」によって、ログとして保存されるシグナルの種類や、エラー分析でアクセスできる中間表現が変わります。そのため、単にソフトウェアを分割するだけでなく、「どのレイヤーからどのような形でデータを取り出すか」を意識したモジュール設計が重要になります。

## センサーとデータフロー

自動運転スタックをデータの流れという観点で見ると、最上流にはセンサーがあります。カメラは高解像度の画像フレーム列、LiDAR は 3D 点群、Radar はレンジ・ドップラー情報、GNSS/IMU は時系列の状態推定値を、それぞれ高い帯域で出力します。これらはオンライン推論用のリアルタイム処理に加え、オフライン学習・評価のためのログとしても保存されます。

センサー生データは、校正情報 (calibration) やタイムスタンプ同期を含めた前処理を経て、知覚モジュールに渡されます。知覚の出力は、例えば以下のような構造化データです。

- バウンディングボックスや 3D ボックス付きのオブジェクトリスト
- レーン境界や停止線のポリライン
- ドライブブルゾーン (drivable area) のマスク

予測モジュールは、これらの知覚結果と過去の履歴を入力として、将来数秒間の軌道分布や行動クラスを出力します。計画モジュールは、予測結果とマップ情報、自車状態を入力とし、コスト関数や制約条件に基づいて安全かつ快適な経路・速度プロファイルを生成します。最後に制御モジュールが、このモーションプランを追従するように車両を制御します。

閉ループなデータエンジンの観点では、この一連の流れの中でどこからログを取得し、どのレイヤーのシグナルをフィードバックに使うのかが重要です。センサー生データだけでなく、知覚・予測・計画の中間表現や診断情報を記録することで、後段のデバッグや評価が容易になります。

### 代表的な信号とログ設計の例

実務では、スタック各段から以下のような情報をログとして収集することが多いです。

- センサー段: 生画像・点群のほか、露出・ノイズ指標、キャリブレーション状態、センサー温度などのメタデータ。
- 知覚段: オブジェクトのクラス・位置・速度に加え、予測確率や不確実性スコア、各クラスごとのスコア（ロジット）など。
- 予測段: 各アクターごとの複数モード軌道、各モードの確率、将来ステップごとの分散や安全マージン。
- 計画段: 評価した候補軌道と各軌道のコスト内訳（安全・快適・効率など）、最終的に採用した軌道とその理由。
- 制御段: 目標値と実際の制御出力、トラッキング誤差、コントローラの内部状態。

これらを統一フォーマットで記録しておくことで、オフラインのエラー分析・再現実験・シミュレーションでスタック全体の挙動を再現しやすくなります。例えば、第 3 章で扱うデータレイク設計では、「1 フレーム（または短い時間窓）に対応するレコードとして、センサー・知覚・予測・計画・制御の出力をひとまとめにしたスキーマ」を設計することが多いです。

ここで重要なのは「スタック各段の入出力を、後からクエリしやすい形で構造化しておく」ことです。データ中心・Closed-Loop の観点では、このようなスキーマ設計の良し悪しが、エラー分析と改善サイクルのスピードに直結します。

## 世界モデルと BEV 表現の位置づけ

近年の研究・実務では、従来の「モジュールごとに別々の表現を持つ」構成に加えて、世界モデル (world model) や BEV (bird's-eye view) 表現といった共通表現をスタック全体で共有するアーキテクチャが注目されています。センサー情報をいったん BEV 特徴マップやオキュパンシーグリッドに変換し、その上で知覚・予測・計画を一貫したニューラルネットワークとして扱うアプローチです。

このようなアーキテクチャでは、「どのタスクのためにどのデータを集めるか」だけでなく、「世界モデルをどのようなデータで事前学習し、どのタスクにファインチューニングするか」といった観点が重要になります。大規模な自車走行ログやシミュレーションデータを用いた自己教師あり学習 (self-supervised learning) により、世界モデルの表現力を高める動きも活発です。

データ中心・Closed-Loop の観点から見ると、世界モデルは「フリート全体から集めたデータの情報圧縮された要約」であり、実世界からのフィードバックを取り込む中核的なコンポーネントと捉えることができます。本書の後半では、世界モデルや BEV 表現を活用した Closed-Loop 評価・データ選択の具体例にも触れます。

### BEV / Occupancy ベース統合スタックの具体像

BEV や Occupancy (占有) をベースとした統合スタックでは、カメラ・LiDAR・Radar などのセンサーデータが、まず 3D または 2.5D のグリッド表現に投影されます。代表的な手法では、次のような流れをとることが多いです。

1. カメラ画像から CNN で特徴マップを抽出し、カメラ内外部パラメータと深度推定に基づいて BEV 平面へ特徴を投影する。
2. LiDAR 点群から voxel 化や pillar 化した特徴を抽出し、同じ BEV 平面に統合する。
3. 統合 BEV 特徴マップを Transformer や畳み込みネットワークで処理し、オブジェクト検出・オキュパンシー予測・未来オキュパンシー予測・軌道生成などをマルチタスクで同時に出力する。

このような世界モデル的アーキテクチャでは、従来モジュール境界に分散していた機能が単一のネットワークに集約される一方で、「どのタスクがどの部分のデータに依存しているか」を明示的に設計・評価する必要があります。データ中心の観点では、例えば「悪天候時の Occupancy 予測精度が低下している場合に、どのセンサー・どの時間帯・どの ODD セグメントのデータを増やすべきか」を、世界モデルの誤差パターンから逆算することが重要です。

### 世界モデルと Closed-Loop 評価の関係

世界モデルを用いたスタックでは、Closed-Loop 評価においても「世界モデルの内部状態」が重要な役割を果たします。従来のコンポーネントベース評価では、知覚・予測・計画それぞれの出力を個別に評価していましたが、世界モデルでは「将来の Occupancy 分布」や「マルチエージェントの相互作用」といった高次元の内部表現が、直接安全性に関わります。

例えば、デジタルツイン上でのシミュレーションでは、世界モデルに実世界ログを与えて再現性を評価し、その上で仮想シナリオを生成して多様性と安全マージンを評価する、といった二段階の Closed-Loop 評価が考えられます。第 7 章では、こうした世界モデル評価の具体的な指標やシナリオ設計について詳しく扱いますが、本節では「世界モデルは単なる大きなニューラルネットワークではなく、フリートデータを通じて継続的にアップデートされる環境モデルである」ということを押さえておいてください。

## Data-Centric な視点から見た各モジュール

自動運転スタックの各モジュールは、異なる性質のデータと評価指標を持ちます。

- 知覚: アノテーションコストが高い一方で、ラベルの定義を厳密にコントロールしやすいモジュールです。データ中心の改善では、難例シーンのブートストラップやオートラベリングが重要な役割を果たします。
- 予測: マルチモーダルな将来軌道を扱うため、ラベルのあいまいさや評価指標の設計が難しいモジュールです。ODD ごとの交通文化や法規も影響します。
- 計画・制御: 明示的なラベルを大量に用意することが難しく、Closed-Loop シミュレーションや人間ドライバーとの比較といった間接的な評価が中心になります。

データ中心・Closed-Loop の視点では、「どのモジュールのどの失敗を、どのようなデータで改善するか」を明確に定義することが、開発効率と安全性の両立に不可欠です。例えば、特定のシナリオでのヒヤリハット事象が発生した場合、その根本原因が知覚の認識漏れなのか、予測の不確実性なのか、計画のコスト設計なのかを切り分け、それぞれに対応するデータ収集・ラベリング戦略を設計する必要があります。

本書では、以降の章で各モジュールにおけるデータの扱い方や Closed-Loop 改善の実践例を詳しく解説していきます。本節で示した全体像を頭に入れておくことで、個々の技術トピックが自動運転スタック全体のどこに位置しているかを意識しながら読み進めることができます。

### モジュール別の Closed-Loop 改善の例

最後に、各モジュールが Closed-Loop の中でどのように改善サイクルに組み込まれるかを、簡単な例としてまとめておきます。

- 知覚 (perception):
  - オンラインモニタリングで検出された誤検出・検出漏れシーンを収集し、ラベリングキューに投入する。
  - ラベルポリシーやアノテーションツールを改善し、難例シーンを重点的に再ラベルする。
  - Long-tail データセット上の mAP や recall を追跡し、改善度合いを評価する。
- 予測 (prediction):
  - 実世界ログ上で、他車の将来軌道予測の外れが大きかったシーンを抽出する。
  - そのシーンに対し、ラベルとなる「人間ドライバーの挙動」や安全マージンを詳細に解析する。
  - 将来軌道分布の評価指標（ADE/FDE や collision rate）をシナリオ別に計測し、データセット構成やモデルを見直す。
- 計画・制御 (planning / control):
  - シミュレーションやログリプレイで、特定シナリオにおける不自然な動き・安全マージン不足・快適性低下を検出する。
  - コスト関数の設計や制約条件の設定が問題なのか、あるいは上流モジュール（知覚・予測）の情報が不足しているのかを切り分ける。
  - 必要に応じて、追加のセンサ情報や世界モデルの特徴を計画モジュールに取り込むデザインを検討する。

このように、スタック全体の観点から「どのレイヤーで何が起こっているか」を把握し、それぞれに対応するデータ改善アクションを設計することが、データ中心・Closed-Loop な自動運転開発の鍵となります。第 2〜8 章では、この全体像を分解しながら、各レイヤーでの具体的な設計・運用方法を順に掘り下げていきます。

## HD マップ・ローカライゼーション・V2X のデータ的役割

outline でも挙げたように、HD マップ (high-definition map)、ローカライゼーション (localization)、V2X 通信 (vehicle-to-everything) は、自動運転スタックにおいて「環境文脈」を提供する重要なコンポーネントです。この節では、これらがどのようなデータを扱い、どのように他モジュールと連携しているかを、データ中心の観点から整理します。

### HD マップの内容と更新サイクル

HD マップは、従来のナビゲーション用地図よりもはるかに高い解像度と精度を持ち、以下のような情報を含むことが多いです。

- 幾何情報: 道路境界、レーン境界、レーン中心線、縁石、ガードレールなど。
- 規制情報: 制限速度、進行方向制限、一時停止、信号機・標識の種類と位置。
- 付加情報: 勾配、路面のカント、橋・トンネル、横断歩道や停止線の位置。

これらは、ローカライゼーションや計画モジュールにとって、環境の「静的コンテキスト」として機能します。一方で、実世界の道路環境は工事や新設道路、規制変更によって常に変化し続けるため、HD マップ自体も継続的に更新されなければなりません。

データ中心・Closed-Loop の観点では、HD マップは「静的データベース」というより、「フリートからの観測と編集を通じてアップデートされ続ける半動的データセット」として扱われます。例えば、ローカライゼーションの残差や知覚結果とマップの不一致を監視し、一定以上の不一致が検出された地点をマップ更新候補としてフラグする、といった運用が考えられます。

### ローカライゼーションのデータフロー

ローカライゼーション (localization) モジュールは、GNSS、IMU、ホイールエンコーダ、LiDAR/Camera ベースの特徴マッチングなどから、自車位置と姿勢を推定します。多くのシステムでは、カルマンフィルタや因子グラフベースの最適化により、これらの情報を統合しています。

ローカライゼーションの出力は、以下のような形で他モジュールに消費されます。

- 知覚: マップ座標系とセンサー座標系の変換により、オブジェクトやレーンの位置を世界座標で表現する。
- 予測: 他車や歩行者の軌道を地図上のパスとして推定する。
- 計画: レーン中心線や交差点構造と自車位置を組み合わせて、将来の経路・軌道を設計する。

データ中心の観点では、ローカライゼーション精度の時間変化や ODD セグメントごとの誤差分布を統計的に把握し、「どの領域ではローカライゼーションが弱く、その結果として知覚・計画側にどのような影響が出ているか」を分析することが重要です。特に、都市キャニオンやトンネル、マップ未整備領域などの「ローカライゼーション難所」を明示的にリストアップし、Long-tail セットとして扱うアプローチが有効です。

### V2X 通信の情報とログ設計

V2X (vehicle-to-everything) 通信は、他車両やインフラからの情報を受信し、認識の補完や先読み安全に活用するための手段です。代表的な情報としては、以下のようなものがあります。

- 他車両の位置・速度・意図（ターンインジケータ、ブレーキなど）。
- 信号機のフェーズ・残り時間などの SPaT (Signal Phase and Timing) 情報。
- 道路工事や事故情報などのインフラからの通知。

V2X 情報は、センサベースの認識と比較すると「信頼性・遅延・カバレッジ」が大きく異なるため、その取り扱いには注意が必要です。データ中心・Closed-Loop の観点では、V2X 情報の有無や品質がモデル性能や安全性指標に与える影響を評価し、「V2X に依存しすぎない設計」と「V2X を最大限活用する設計」のバランスを検討することが重要です。

また、V2X 情報自体もログとして保存し、後からシミュレーションで再現できるようにしておく必要があります。特に、シグナルフェーズ情報や他車の意図情報は、計画モジュールの意思決定に大きな影響を与えるため、Closed-Loop 評価の際に「V2X 有り／無し」の両方の条件で挙動を比較できるようにしておくと有用です。

## まとめ: スタック全体像とデータエンジンの接点

本節では、自動運転スタックの典型的な構成要素と、それぞれがどのようなデータを扱い、どのように相互作用しているかを俯瞰しました。同時に、世界モデル・BEV 表現、HD マップ・ローカライゼーション・V2X などのコンポーネントが、データ中心・Closed-Loop な開発においてどのような役割を果たすかを整理しました。

ここで示したスタック全体像を踏まえると、Closed-Loop データエンジンとの接点は次のように整理できます。

- データ収集 (第 2 章): どのセンサー・どのモジュール出力をどの粒度でログに残すかを、スタック構造と一貫性を持って設計する。
- データ保存・インジェスト (第 3 章): Drive / Scene / Frame 単位のスキーマ設計において、スタック各段の信号をどのように格納・索引付けするかを定める。
- データ選択・前処理 (第 4 章): 特定モジュールの弱点に対応するシーンを、スタックの中間表現や診断情報を用いて効率よく抽出する。
- データラベリング (第 5 章): 知覚・予測・計画それぞれのタスクに適したラベルとタクソノミを設計し、スタックの入出力と整合性を持たせる。
- モデル学習と評価 (第 6・7 章): スタック全体・部分スタックの両方を対象に、Closed-Loop 評価とオフライン評価を組み合わせて改善サイクルを回す。
- 実世界展開とフィードバック (第 8 章): OTA やオンラインモニタリングを通じて、スタック各段からフィードバックシグナルを収集し、再びデータエンジンに戻す。

以降の章では、この全体像をガイドにしながら、各レイヤーでの具体的な設計・実装・運用の詳細に踏み込んでいきます。読者のみなさんには、自身のプロジェクトに適用したときに「どのモジュールからどのようなデータを取り出し、どのモジュールにどのようなデータを戻す Closed-Loop を構築すべきか」をイメージしながら読み進めていただきたいです。

なお、本節で示したスタック構成やデータフローは、あくまで典型例であり、すべてのプロジェクトにとって唯一の正解というわけではありません。実際には、プロジェクト規模、利用可能なセンサー、求められる自律レベル (SAE レベル)、法規制やビジネス要件などに応じて、多様なバリエーションが存在します。そのため、読者のみなさんには、自身の状況に合わせてスタック構造をカスタマイズしつつも、「どのようにデータが流れ、どこでどのような閉ループが形成されているか」という観点を常に意識していただきたいです。

