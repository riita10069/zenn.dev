---
title: "7.6 テストシナリオ管理とカバレッジ設計"
---

# 7.6 テストシナリオ管理とカバレッジ設計

この節では、テストシナリオ管理とカバレッジ設計について解説します。ODD セグメント別・機能別のカバレッジ指標、ログマイニングからのシナリオ抽出・クラスタリング、フリートデータとシミュレーションの橋渡しを整理し、データ中心・Closed-Loop の観点から「テストカバレッジのギャップを定量的に把握する」方法を考えます。

## シナリオ管理とメタデータ設計

第 7.2 節で述べたように、シナリオ DB はシナリオベーステストの中核です。本節では、特にカバレッジ設計に関わるメタデータ設計に焦点を当てます。典型的には、各シナリオに対して次のような属性を管理します。

- ODD セグメント:
  - 地域（都市名・道路ネットワーク ID）
  - 道路種別（高速道路、幹線、住宅街など）
  - 環境条件（天候、時間帯、季節）
- 機能・システム観点:
  - 関連する機能（車線維持、ACC、自動レーンチェンジ、交差点右左折など）
  - 関連する安全目標・要件 ID
- シーン構造:
  - 交差点種別（信号あり／なし、ラウンドアバウトなど）
  - 交通参加者構成（歩行者有無、自転車有無、重車両有無など）

これらのメタデータが整っていると、後述するカバレッジ指標の計算や、ログマイニングから抽出した新シナリオとの突き合わせが容易になります。

## ODD セグメント別・機能別カバレッジ指標

カバレッジ (coverage) を定量化するためには、「どの軸に対してどのような分布を目標とするか」を事前に決める必要があります。第 2 章で扱った ODD 定義と整合を取りつつ、テストシナリオに対して次のような指標を設計することが考えられます。

- シナリオ数ベースのカバレッジ:
  - 各 ODD セグメント × 機能カテゴリの組み合わせごとに「登録されているシナリオ数」を集計する。
  - 目標値（例: 各セル少なくとも 10 シナリオ）と比較し、ギャップを可視化する。
- 実行回数ベースのカバレッジ:
  - 各シナリオが、最新モデルに対して何回実行されているかをトラッキングする。
  - リグレッションテストの観点から、「重要シナリオが毎回のモデル更新で十分にカバーされているか」を確認する。
- リスク加重カバレッジ:
  - シナリオごとにリスクスコア（重大度 × 発生頻度 × 検知性など）を付与し、高リスクセルほど高いカバレッジを要求する。

このような指標をダッシュボードで可視化することで、「どの領域でテスト不足か」「モデル更新時にどのシナリオを優先的に回すべきか」を客観的に議論できるようになります。

## ログマイニングによるシナリオ抽出・クラスタリング

テストシナリオを網羅的に設計することは困難であり、フリートから収集したログを分析しながら、シナリオセットを継続的に拡張していくアプローチが現実的です。ログマイニング (log mining) では、以下のような手法が用いられます。

- ルールベース抽出:
  - 急制動・急ハンドル・AEB 介入・運転者介入などのトリガを条件として、関係する時間区間を抽出する。
  - 特定の道路種別や環境条件に絞って抽出する。
- クラスタリング:
  - 各走行シーンを、位置関係・速度プロファイル・相対距離などの特徴量に埋め込み、クラスタリングする。
  - クラスタごとに代表シナリオを選び、シナリオ DB に登録する。
- アノマリ検知:
  - 正常走行分布から大きく外れた挙動を持つシーンを検出し、「未知・未想定シナリオ」の候補とする。

これらの手法で抽出したシーンに対して、シナリオプランナーや安全チームがレビューを行い、シナリオ DB に正式登録していく、という Closed-Loop を構成します。重要なのは、「ログマイニングの結果がそのままシナリオになる」のではなく、人間のレビューと安全評価を経てシナリオとして確定する点です。

## フリートデータとシミュレーションの橋渡し

フリートデータとシミュレーションを橋渡しする際には、次のような観点が重要になります。

- シーンの再現性:
  - 実車ログからシミュレータ上で再現可能なシーンをどの程度カバーできるか。
  - マップ・キャリブレーション・センサモデルの整備状況に応じて、再現可能領域を明示する。
- シーンの一般化:
  - 実ログから抽出したシーンを、そのまま「記録した通りのシナリオ」として扱うだけでなく、パラメータ化して近傍のシナリオ空間に一般化する。
  - 例えば、「右折時に対向直進車とギャップが小さい」シーンを、対向車速度・距離・信号タイミングなどのパラメータとして表現し、多数のバリエーションを生成する。
- 双方向のフィードバック:
  - シミュレーションで見つかった失敗シナリオに類似する実世界シーンをログから検索し、実車での頻度や影響度を評価する。
  - 実車でのインシデントを端緒として、シミュレーション上で条件を変えた多数のシナリオを生成し、対策の有効性を検証する。

このように、フリートデータとシミュレーションを行き来するパスを整備しておくことが、データ中心・Closed-Loop の鍵となります。

## 継続的カバレッジモニタリングと運用ルール

最後に、テストシナリオカバレッジを継続的にモニタリングし、運用に組み込む際の具体的なルール例を示します。

- ルール例 1: モデルリリース前に満たすべきカバレッジ条件
  - 高リスク ODD セグメントについては、シナリオ数・実行回数ともに目標値以上であること。
  - 重要安全目標に紐づくシナリオについては、最新モデルに対する成功率が所定のしきい値を超えていること。
- ルール例 2: 新しいインシデント発生時の対応
  - インシデントが発生した場合は、一定期間内にそのシーンをもとにしたシナリオをシナリオ DB に登録する。
  - 同種のシナリオが既に存在するかを自動検索し、重複・統合を検討する。
- ルール例 3: カバレッジギャップへの対応
  - カバレッジが不足しているセルに対しては、フリート走行計画やシミュレーションシーン生成の優先度を上げる。
  - 一定期間ギャップが解消されない場合は、ODD 定義やサービス仕様自体の見直しも含めて検討する。

このような運用ルールを組織的に定め、ツールで自動チェックできる形にすることで、「なんとなく十分テストしたはず」という状態から、「データに基づいてテストカバレッジを管理している」状態へと移行できると考えられます。
