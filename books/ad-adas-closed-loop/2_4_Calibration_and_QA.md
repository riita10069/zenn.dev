# 2.4 キャリブレーションと品質管理

この節では、車載センサーのキャリブレーション (calibration) と品質管理について解説します。Camera / LiDAR / Radar / IMU などの内部・外部キャリブレーション、時間経過によるキャリブレーションドリフトの検知と再キャリブレーショントリガ、オンライン／オフラインでの役割分担を整理します。データ中心・Closed-Loop の観点から、キャリブレーション品質が学習データとモデル性能にどのように影響するかを理解することが目的です。

## 内部・外部・時変キャリブレーション

キャリブレーションは、大きく内部 (intrinsic)、外部 (extrinsic)、時変 (time-varying) の 3 つに分けて考えることが多いです。

- 内部キャリブレーション: カメラの焦点距離・歪み係数、LiDAR のビーム角度、IMU のバイアスなど、各センサー単体のパラメータを推定します。
- 外部キャリブレーション: センサー間の位置・姿勢関係（例えば、カメラと LiDAR の相対位置）を車両座標系に対して推定します。
- 時変キャリブレーション: 経年劣化や衝撃、温度変化などによりキャリブレーション値が変化する現象をモデリングし、必要に応じて再推定します。

キャリブレーションが不正確な場合、センサフュージョン結果や BEV マップ、ローカライゼーション精度に直接影響し、そのまま学習データや評価結果の品質低下につながることが多いです。そのため、データ中心開発では「キャリブレーション情報もデータの一部」であると捉え、適切に管理することが重要です。

キャリブレーション誤差は、単純なバイアスだけでなく、条件依存性を持つこともあります。例えば、温度や振動条件によって LiDAR のビーム方向がわずかに変化する、カメラマウントのたわみにより走行状態ごとに外部パラメータが変動する、といった現象です。これらを完全にモデル化することは難しいため、「どの程度の誤差までを許容範囲とするか」「どの程度の誤差から再キャリブレーションを行うか」を、データと評価に基づいて決めていく必要があります。

## キャリブレーションドリフト検知と再キャリブレーショントリガ

現実の運用では、キャリブレーションは時間とともに徐々にずれていくことがあります。これを検知し、適切なタイミングで再キャリブレーションを行う仕組みが必要です。

代表的なアプローチとして、以下のようなものがあります。

- 自己整合性チェック: 複数センサーから得られる情報（例えば、カメラ画像上の特徴点と LiDAR 点群の投影位置）がどの程度整合しているかを指標化し、閾値を超えた場合にアラートを出す。
- 環境構造を利用したオンライン推定: 路面や建物など、幾何的にシンプルな構造物を利用して、オンラインで外部キャリブレーションの微調整を行う。
- 定期メンテナンス時の再キャリブレーション: 車検や整備のタイミングでキャリブレーションを再実施し、その履歴を管理する。

Closed-Loop の観点では、キャリブレーションドリフトが検出された車両からのデータを、学習データセットに含めるかどうか、どのような補正を行うかをポリシーとして定めておくことが重要です。また、キャリブレーション状態とモデル性能・ヒヤリハット発生率の相関を可視化することで、フリート全体の健全性を把握しやすくなります。

実務では、例えば次のような基準が運用されることが多いです。

- 外部キャリブレーション誤差が一定以上（例: 数 cm・数度）と推定された場合、その期間のデータは学習用データセットから除外するか、別タグを付与する。
- ドリフト検知指標がしきい値を超えた車両に対して、自動的に「要再キャリブレーション」フラグを立て、整備計画に反映する。

このようなポリシーを明文化し、ログやメタデータとして残しておくことで、「ある学習データセットがどの程度のキャリブレーション品質を前提にしているか」を後から確認できるようになります。

## オンライン／オフライン キャリブレーションの分担

キャリブレーションには、車両上でリアルタイムまたは準リアルタイムに行うオンライン方式と、工場やサービスセンター、オフラインバッチ処理で行うオフライン方式があります。

- オンラインキャリブレーション: 軽量なアルゴリズムでキャリブレーションパラメータの変化を検知・補正し、運用中の性能低下を抑えることを目的とします。
- オフラインキャリブレーション: より重い最適化や人手による検証を伴い、高精度なキャリブレーション値を得ることを目的とします。

データ中心・Closed-Loop の観点では、オンライン・オフラインそれぞれの結果をメタデータとして記録し、どの時刻にどのキャリブレーション状態でデータが収集されたかを追跡可能にしておくことが重要です。これにより、「特定期間のモデル性能低下がキャリブレーションドリフトに起因していた」といった分析が可能になります。

オンラインキャリブレーションは、計算資源やレイテンシの制約から、すべてのセンサーやパラメータに対して実施することは難しい場合が多いです。そのため、次のような設計が現実的です。

- オンラインでは、外部キャリブレーションの「微小な補正」に限定し、大きな変化が検出された場合はオフライン再キャリブレーションを要求する。
- オフラインでは、複数セッションや複数ロケーションにまたがるデータを用いて、よりグローバルな最適化を行う。

この二段構えにより、運用中の性能劣化を抑えつつ、定期的にキャリブレーション状態を「リセット」することができます。Closed-Loop データエンジンの中では、オフライン再キャリブレーション結果をデータレイクに反映させ、過去ログにさかのぼって補正を適用するか、もしくはキャリブレーション状態ごとにデータを分割して扱うか、といった設計判断も重要になります。

## キャリブレーション情報のメタデータ化とデータセットへの反映

キャリブレーションは数値パラメータとして存在するだけでなく、データセット設計や評価指標とも結び付ける必要があります。例えば、次のようなメタデータを Drive / Scene / Frame レベルで持つ設計が考えられます。

- 使用したキャリブレーションバージョン（工場出荷時、再キャリブレーション日時など）。
- オンライン推定によるキャリブレーション品質指標（自己整合性スコア、残差統計）。
- センサー交換・修理・マウント変更などのイベントログ。

これらの情報をもとに、

- キャリブレーション状態が安定している期間だけを学習データセットに含める。
- あえてキャリブレーション状態の悪い期間も含め、モデルにロバスト性を持たせる（ただし評価は状態別に分けて行う）。

といったデータセット設計が可能になります。データ中心・Closed-Loop の観点では、「キャリブレーション状態を無視した平均的な評価」だけでなく、「状態別の性能」を測ることで、どの程度の誤差までならシステムが許容できるかを定量的に把握することが重要です。

## キャリブレーションとラベリング・評価の関係

キャリブレーション品質は、ラベリングや評価にも直接影響します。例えば、

- LiDAR とカメラの外部キャリブレーションがずれていると、画像上のバウンディングボックスと点群上の 3D ボックスの整合性が崩れ、ラベラーの負荷が増加します。
- ローカライゼーションが不安定な期間のログでは、HD マップ上のオブジェクト位置やシナリオラベル（どのレーンを走っていたかなど）の品質が低下する可能性があります。

このような場合、次のような対策が考えられます。

- キャリブレーション品質が一定以上のログだけをラベリング対象とし、それ以外のログはキャリブレーション改善後に再収集するか、別用途（例えば自己教師あり学習）に回す。
- ラベリングツールでキャリブレーション情報を可視化し、整合性が悪いフレームに警告を出す。

第 5 章では、ラベリング品質管理の中でキャリブレーションをどのように扱うかを詳しく扱いますが、本節では「キャリブレーションはラベル品質と評価の前提条件である」という点を強調しておきます。

