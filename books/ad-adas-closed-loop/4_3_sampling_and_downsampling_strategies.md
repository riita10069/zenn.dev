---
title: "4.3 サンプリング・ダウンサンプリング戦略"
---

# 4.3 サンプリング・ダウンサンプリング戦略

この節では、常時走行ログから学習・評価データセットを構築する際のサンプリング (sampling)・ダウンサンプリング (downsampling) 戦略について解説します。ランダムサンプリング、レアシーンのオーバーサンプリング、ロングテールを意識したバランシング、フレームレートの間引き、シナリオ単位のサンプリングなどを整理し、データ中心・Closed-Loop の観点から「データ量と多様性のトレードオフ」を考えます。

## ランダムサンプリングと代表性

大規模フリートでは、全走行ログをそのまま学習に使うことは計算資源的に困難なため、ランダムサンプリングにより代表的なサブセットを構築することが多いです。ただし、単純な時間均一サンプリングでは、頻度の高い「平凡なシーン」に偏り、ロングテールなシーンが極端に少なくなる傾向があります。

ランダムサンプリングを設計する際には、少なくとも以下の点を意識します。

- 時刻・天候・地域などのメタデータを考慮した層別サンプリング (stratified sampling) とする。
- Drive / Trip / Scene 単位でのサンプリングを行い、連続フレーム間の相関による「実効サンプル数」の減少を抑える。
- 学習用と評価用のサンプルが同じ Drive から選ばれないようにし、リークを防ぐ（4.6 節と連携）。

データレイク上では、テレメトリやメタデータを含むテーブル（例: 走行単位の概要テーブル）を用意し、SQL や分散処理フレームワーク（Spark / BigQuery 等）からサンプリングジョブを実行する構成が多いです。サンプリングポリシーをクエリや設定ファイルとしてリポジトリで管理しておくと、将来の再現性や監査に役立ちます。

## レアシーンのオーバーサンプリングとロングテールバランシング

ロングテール問題に対処するため、以下のような戦略が考えられます。

- ヒヤリハット・介入・AEB 介入などのイベント周辺シーンを高い確率でサンプリングする。
- ラベルやメタデータに基づいて、レアクラス（例: 歩行者飛び出し、自転車の逆走など）を意図的にオーバーサンプリングする。
- サンプルごとの重み付けにより、学習時にロングテールシーンの影響を強める。

レアシーンのオーバーサンプリングは、データ選択と学習戦略の両方で実現できます。

- データ選択レベル：シーン検索やイベントログを用いて、特定クラスや特定シナリオのシーンを意図的に多めに収集・ラベリングする。
- 学習レベル：クラス重み付けやフォーカルロス (focal loss) のような損失設計により、ロングテールクラスの寄与を高める。

自動運転向け公開データセットでも、ロングテールなクラス（ベビーカー、電動キックボード、工事標識など）のサンプル数が少なく、評価結果が統計的に不安定になりやすいことが知られています。このため、レアクラスをどこまでオーバーサンプリングするかは、データ分布と実際の安全要求のバランスを見ながら調整する必要があります。

## フレームダウンサンプリングとシーン長の設計

常時記録された動画やセンサデータから学習・評価用のデータセットを構築する際には、フレームレートをどこまで保持するかが重要な設計要素になります。

- Perception モデルでは、画像フレームを一定間隔ごとにサンプリングし、フレーム間の冗長性を減らす。
- Tracking / Prediction / Planning モデルでは、数秒〜十数秒程度のシーン単位の切り出しを行い、その中での連続フレームを利用する。

フレームダウンサンプリングの設計では、以下の観点を考慮します。

- どのタスクを対象とするか（静止画ベースか、時系列ベースか）。
- 車速・環境による「見かけの変化量」（高速道路では短時間で環境が大きく変わる）。
- センサフュージョン時の同期要求（LiDAR・Radar との同期を取りやすいフレーム間隔）。

実装面では、ROS bag や独自バイナリフォーマットからシーンを切り出し、画像・点群・テレメトリをフレーム単位で整理したフォーマット（例: WebDataset、TFRecord、Arrow/Parquet ベースのフォーマットなど）に変換しておくと、後続のダウンサンプリングやバッチ構成が行いやすくなります。

## シナリオベースサンプリングと評価セット設計

Planning や Closed-Loop 評価を強く意識する場合、シーン単位ではなくシナリオ単位のサンプリングが重要になります。シナリオベースサンプリングでは、

- 信号交差点での右折シナリオ。
- 高速道路での合流・車線変更シナリオ。
- 歩行者の飛び出しや工事ゾーンなどのハザードシナリオ。

といったシナリオカテゴリを定義し、それぞれから一定数のサンプルを選択します。シナリオの定義には、第 5 章で扱うラベル・タクソノミや、第 7 章で扱うシナリオモデルが関係してきます。

評価セット設計では、単純なランダムサンプリングだけでなく、「安全上重要なシナリオの比率を意図的に高めたセット」「実際の運用分布に近いセット」の両方を用意し、それぞれの指標を追跡する構成がよく用いられます。これにより、「現実世界での平均性能」と「ハザードシナリオに対する保守性」の両面をモニタリングできます。

## Closed-Loop におけるサンプリング戦略の更新

Closed-Loop の観点では、サンプリング戦略は固定されたルールではなく、エラー分析・アクティブラーニング・実運用からのフィードバックによって継続的に更新されます。

- オフライン評価やシミュレーションでの失敗シーンを収集し、その近傍の類似シーン（4.7 節）をサンプリング候補とする。
- モデルの不確実性・異常スコア（4.8 節）を用いて、追加収集・再ラベリングが必要な領域を特定する。
- 実運用でのヒヤリハット・インシデント情報（第 8 章）から、「どのシナリオが現状のデータセットで過小評価されているか」を分析する。

実務では、サンプリングポリシーをコードや設定としてリポジトリで管理し、変更履歴を追跡できるようにしておくことが望ましいです。ワークフローオーケストレータ（Airflow, Dagster 等）上で「サンプリングジョブ」を定義し、ポリシー変更を Pull Request ベースでレビュー・適用することで、サンプリング戦略そのものを DataOps / MLOps の一部として扱えるようになります。

