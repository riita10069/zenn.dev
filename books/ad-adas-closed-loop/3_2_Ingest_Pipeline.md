# 3.2 インジェストパイプライン

この節では、車両からアップロードされたデータをクラウド側で受け取り、データレイクに取り込むインジェストパイプライン (ingest pipeline) について解説します。キューイング・ストリーミング・バルクインポートの組み合わせ、Idempotent なインジェストと重複排除、簡易ビューワや検品 UI の役割を整理します。データ中心・Closed-Loop の観点から、インジェスト品質が後続のデータ選択・学習・評価の基盤となることを理解することが目的です。

## キューイング・ストリーミング・バルクインポート

インジェストパイプラインでは、データ量やリアルタイム性の要求に応じて、メッセージキューやストリーミング基盤、バルクインポートバッチの組み合わせを設計します。

- キューイング (queuing): 車両からのアップロードをメッセージキュー（例: Kafka 的なシステム）で受け止め、バックエンド処理の負荷変動を吸収します。
- ストリーミング (streaming): 低レートテレメトリやオンラインモニタリング用データは、ストリーミング処理でリアルタイム集計や異常検知に回します。
- バルクインポート (bulk import): 大容量のセンサログや録画は、ストレージに格納されたファイルをバッチ処理でデータレイクに取り込みます。

Closed-Loop の観点では、「どのデータをほぼリアルタイムで扱うか」「どのデータは数時間〜数日遅延してもよいか」を明確にし、モデル監視とモデル改善のサイクルに必要なレイテンシを満たす構成を選ぶことが重要です。

一般的には、

- 安全監視やオンライン指標計算に必要なテレメトリはストリーミング経路で数分以内に処理。
- 学習・評価用のセンサログは、Drive 単位・シーン単位のファイルとして数時間〜数日以内にインジェスト。

といった二段構成が取られます。これにより、「安全性に関わる兆候には素早く反応しつつ、大量の学習データはバッチで効率よく取り込む」というバランスを実現します。

## Idempotent なインジェストと重複排除

アップロードの再送やパイプラインのリトライにより、同一ログが複数回インジェストされる可能性があります。これに対処するため、インジェスト処理は Idempotent（同じ入力に対して何度実行しても結果が変わらない）であることが望ましいです。

具体的には、以下のような設計が考えられます。

- 各ログファイルやチャンクに一意な ID（drive_id や hash）を付与し、データレイク側で存在チェックを行う。
- メタデータテーブルに「受信済み」「処理中」「完了」といったステータスを持たせ、途中で失敗しても再開できるようにする。
- 重複ログはメタデータのみ更新し、実データの二重保存を避ける。

データ中心の観点では、重複や欠損があると正確な統計やカバレッジ評価が行えなくなるため、インジェスト時点での健全性確認が重要な品質ゲートとなります。

Idempotent なインジェスト処理を設計する際には、以下のような実装上の注意点があります。

- ファイル名やオブジェクトキーだけでなく、Drive ID・ハッシュ値・タイムレンジなどから一意なキーを構成し、ダブルチェックを行う。
- インジェスト処理の途中で例外が発生した場合にも、一部だけ登録されて一部は未登録といった中途半端な状態が残らないよう、トランザクション境界を明確にする。
- 再実行時には「既に処理済みの単位（Drive / Scene / Shard）」を認識し、スキップ／更新を正しく切り替える。

これらは、表面的にはインフラ実装の細部ですが、Closed-Loop の観点では「どのデータが 1 回だけ、完全な形でデータレイクに入っているか」を保証するための重要な要素です。

## 簡易ビューワ・検品 UI

大量のログがインジェストされる環境では、すべてを人手でチェックすることはできませんが、少なくとも代表サンプルを目視確認できる簡易ビューワ (quick viewer) や検品 UI を用意することが望ましいです。

例えば、以下のような機能が考えられます。

- ランダムに選ばれたドライブのタイムラインと地図表示。
- カメラ・LiDAR・CAN ログの同期再生。
- データ品質指標（露出統計・点群密度など）の可視化。

Closed-Loop の観点では、インジェスト直後の検品で問題を早期に検知できれば、後段のラベリングや学習に不適切なデータが流れ込むことを防げます。また、検品結果をフィードバックして、データ収集・オンボードモニタリングの設定を改善することも重要です。

検品 UI では、次のような機能を備えておくと、データ中心の改善サイクルを支えやすくなります。

- インジェストされた Drive / Scene をランダムサンプリングし、センサー同期・露出・点群密度・時刻整合などのチェックリストに沿ってレビューできる。
- ODD・車両世代・ソフトウェアバージョン別に、代表シーンを自動選定してレビュー対象として提示する。
- レビュー結果（OK / 要再収集 / 要ラベリングポリシー見直しなど）をメタデータとして保存し、後続のデータ選択・ラベリング戦略に反映できる。

これにより、「インジェストされたが誰も見ていないデータ」が溜まることを防ぎつつ、現場の感覚を Closed-Loop データエンジンに取り込むことができます。

