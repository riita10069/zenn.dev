# 7.5 世界モデル評価・シーン再現性

この節では、世界モデル (world model) 評価とシーン再現性について解説します。ログリプレイによる世界モデル検証、長期予測・マルチエージェント挙動の評価、再現性・多様性・安全マージンといった評価メトリクスを整理し、データ中心・Closed-Loop の観点から「世界モデルをデータエンジンの中核として評価する」方法を考えます。

## 世界モデルの役割と特徴

世界モデル (world model) は、センサデータから環境の状態を抽象化し、将来の状態を予測するモデルの総称です。自動運転においては、以下のような役割を担うことが多いです。

- マルチカメラ・LiDAR・Radar など複数センサからの情報を統合し、BEV (bird's-eye view) などの統一表現に変換する。
- 自車および他エージェントの将来軌道や、地図・信号の変化を予測する。
- シミュレータやプランナに対して、「環境のダイナミクス」を提供する。

世界モデルは、単一のタスク（物体検出や軌道予測など）に限定されないことが多く、自己教師あり学習やマルチタスク学習を通じて、環境の潜在構造を学習します。そのため、評価方法も従来の単一タスクモデルと比べて複雑になりがちです。

## ログリプレイによる世界モデル検証

世界モデル評価の基本は、実車ログを用いたログリプレイ (log replay) です。典型的には、以下のような手順で評価を行います。

1. 実車ログから、センサデータ・地図・真値（オブジェクト軌道、信号状態など）を取り出す。
2. センサデータと地図を世界モデルに入力し、環境状態の再構成と将来予測を行う。
3. 真値と比較し、位置・速度・クラスなどの誤差を指標として集計する。

ここで重要なのは、「世界モデルの入力が現実世界のものと同一である」ことです。シミュレーション上の評価だけでは、センサノイズや同期ズレ、ロングテールな環境条件など、実世界特有の要因を十分に反映できない可能性があるためです。

ログリプレイ評価では、次のような視点を持つと良いです。

- 短期予測と長期予測のバランス（数ステップ先の精度だけでなく、数秒後の挙動傾向）。
- 位置誤差だけでなく、意図（右折する／直進する）のような高レベル予測の正しさ。
- センサ欠損や異常値が存在する区間でのロバスト性。

## マルチエージェント・長期予測の評価指標

世界モデルは、多数のエージェントが相互作用する環境を扱うため、単一エージェントの平均誤差だけでは性能を十分に評価できないことが多いです。代表的な評価指標としては次のようなものがあります。

- ADE / FDE (Average / Final Displacement Error): 予測軌道と真値軌道の平均・最終位置誤差。
- Miss rate: 予測分布が一定距離以内に真値を含まなかった割合。
- Collision rate: 予測軌道同士、あるいは予測軌道とインフラとの衝突率。
- Social compliance: 車線逸脱・信号無視・異常な加速度など、交通ルールや快適性に反する予測の割合。

さらに、マルチエージェント環境では、「他車同士の相互関係」が重要になります。例えば、合流シーンでは、本線車と合流車の予測軌道に一貫したギャップが存在するか、歩行者の行動が車両の減速と整合しているか、といった点も評価すべきです。そのため、ペア・グループ単位での評価指標（相対距離・時間的余裕など）を定義することが有効です。

## 再現性・多様性・安全マージンの評価

世界モデルは単に「真値に近い予測」を出すだけでなく、「現実的なバリエーションを網羅しつつ、安全マージンを確保する」ことが求められます。この観点から、以下のような指標が検討されることが多いです。

- 再現性 (reproducibility):
  - 同じ初期状態からシミュレーションを複数回実行した際に、世界モデルが類似した挙動を再現できるか。
  - 実車ログとシミュレーションの軌道分布がどれだけ一致しているか。
- 多様性 (diversity):
  - 条件付き生成を行った際、同じ条件からどれだけ多様な将来軌道が生成されるか。
  - 生成された軌道が現実離れしていない範囲で分散を持っているか。
- 安全マージン:
  - 予測軌道と他エージェントやインフラとの最小距離。
  - 不可避な衝突を除き、予測分布の大半が安全な領域にあるか。

これらの指標をシナリオ単位・ODD セグメント単位で集計し、第 7.6 節で扱うカバレッジ指標と組み合わせることで、「どのようなシーンで世界モデルが十分に機能していないか」を可視化できます。

## 世界モデルとシミュレータの連携評価

世界モデルは、シミュレータと連携して Closed-Loop の一部として動作することも多いです。例えば、センサシミュレーションの代わりに世界モデルがセンサ特徴量を生成したり、トラフィックシミュレーションに代わって他エージェントの挙動をサンプリングしたりする構成が考えられます。

この場合、単一ステップの予測精度だけでなく、シミュレータ内で長時間実行した際の安定性や一貫性も評価する必要があります。典型的には、次のような観点をチェックします。

- 長時間シミュレーション中に物理的にあり得ない状況（車が地面を離れる、急激な速度変化）が発生しないか。
- 世界モデルが生成する軌道の分布が、実世界で観測された分布から大きく逸脱していないか。
- Planning モジュールとのインタラクションにおいて、過度に楽観的／悲観的な予測が特定シナリオで偏在していないか。

これらの評価は、第 7.4 節で説明した SiL アーキテクチャと組み合わせることで、シナリオベースで自動化することが可能です。

## データ中心・Closed-Loop 観点での世界モデル運用

最後に、世界モデルをデータ中心・Closed-Loop エンジンの中核コンポーネントとしてどのように運用するかを整理します。

- データ選択:
  - 世界モデルが苦手とするシナリオ（予測誤差が大きい、衝突率が高いなど）を自動検出し、第 4 章のデータ選択パイプラインにフィードバックする。
  - 世界モデルを「データ品質診断器」として用い、センサ異常やキャリブレーションズレの検知に活用する。
- データ生成:
  - 世界モデルを用いて将来軌道や環境変化を生成し、第 7.3 節の生成シーンと組み合わせることで、シミュレーション用データを拡張する。
  - 特定の安全マージンを侵すような「攻撃的シーン」を生成し、ロバスト性検証に利用する。
- 継続学習:
  - フリート運用から得られる新しい走行ログを用いて、世界モデルを継続的にアップデートする。
  - アップデート前後の世界モデルを同一シナリオセットで比較し、予測性能だけでなく、Closed-Loop 挙動や安全マージンが改善しているかを確認する。

このように、世界モデルは単なる予測モジュールではなく、「環境の統計的構造を学習し、データ中心・Closed-Loop 開発全体を支える基盤」として位置づけることが重要です。
