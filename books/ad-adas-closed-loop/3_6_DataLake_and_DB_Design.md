# 3.6 データレイク／データベース設計

この節では、自動運転向けデータレイク (data lake) とデータベース設計について解説します。Drive / Scene / Frame テーブル設計、時系列 DB・メタデータ用 RDB / Key-Value ストアの役割、スキーマ進化と後方互換性の考え方を整理します。データ中心・Closed-Loop の観点から、後段のシーン検索・データセット設計・評価に適したスキーマ設計とは何かを考えます。

## Drive / Scene / Frame テーブル設計

多くの組織では、ログを以下のような粒度で管理するテーブル設計を行います。

- Drive テーブル: 1 回の連続走行を表すレコードで、開始・終了時刻、車両情報、ODD 属性などを持ちます。
- Scene テーブル: Drive を細かいシナリオ単位に分割したレコードで、交差点通過、車線変更、合流、ヒヤリハットなどのタグを持ちます。
- Frame テーブル: 単一時刻のスナップショットを表すレコードで、センサフレームへの参照やモデル出力の一部を含みます。

Closed-Loop の観点では、例えば「特定の ODD セグメントかつ特定のシナリオタイプの Scene を抽出し、さらにその中でもモデルが失敗した Frame を特定する」といったクエリを高速に実行できることが重要です。そのため、Drive / Scene / Frame 間のリレーションとインデックス設計が鍵になります。

テーブル設計の際には、次のようなクエリパターンを想定してスキーマを決めると良いです。

- あるモデルバージョンが評価に用いられた全 Frame を取得する（モデル評価ビュー）。
- 特定のインシデント ID に紐づく Drive / Scene / Frame をすべて取得する（インシデント調査ビュー）。
- 特定の ODD・車両世代・ソフトウェアバージョンにおけるシナリオ頻度を集計する（フリート統計ビュー）。

これらを効率的に実現するために、Drive / Scene / Frame テーブル間の外部キーと、主要な属性に対するインデックスを設計します。

## 時系列 DB・メタデータ用 RDB / Key-Value ストア

自動運転ログには、テレメトリやモデルスコアのような時系列データ、走行やシナリオのメタデータ、センサーやソフトウェアの設定値など、多様なデータが含まれます。これらを一種類の DB で扱おうとすると非効率になることが多いため、用途に応じて複数のストアを使い分ける設計が一般的です。

- 時系列 DB: 低レートテレメトリやオンラインメトリクスを格納し、ドリフト検知やトレンド分析に用います。
- RDB / Key-Value ストア: Drive / Scene / Frame のメタデータやインデックス情報を格納し、複雑なクエリや高速ルックアップを支えます。
- 検索エンジン: テキストベースのタグや自然言語クエリを扱うために、全文検索エンジンを併用することもあります。

データ中心の観点では、「どのクエリパターンが Closed-Loop の中で頻出するか」を踏まえ、最適なストアの組み合わせとスキーマ設計を行うことが重要です。

例えば、

- テレメトリの異常検知やトレンド分析には、時系列 DB（Prometheus / InfluxDB 的なもの）を用い、数秒〜数分オーダーの集計を行う。
- Drive / Scene / Frame メタデータやラベル情報には RDB や分散キー・バリューストアを用い、柔軟な結合・フィルタリングを可能にする。
- シーン検索や自然言語検索には検索エンジンやベクトル DB を用い、Embedding ベースの類似検索を実現する。

といった役割分担です。第 4 章・第 7 章で扱うシーン検索やカバレッジ分析では、これらのストアをまたいだクエリが多く発生するため、「どの情報がどこにあり、どのような JOIN を行うか」をアーキテクチャとして整理しておく必要があります。

## スキーマ進化と後方互換性

長期運用を前提とすると、センサー構成やラベルスキーマ、モデル出力形式などは時間とともに変化していきます。そのため、データレイクとメタデータスキーマは、変更を前提に設計しなければなりません。

- スキーマにバージョンフィールドを持たせ、各レコードがどのスキーマバージョンで書かれたかを明示する。
- 追加フィールドは極力後方互換な形で導入し、既存レコードは null / default 値で扱う。
- 互換性が保てない大きな変更が必要な場合は、新旧スキーマをしばらく併存させる移行期間を設ける。

Closed-Loop の観点では、スキーマ変更が評価結果やモデル学習に与える影響を最小化し、変更をトレースできるようにすることが重要です。例えば、「どのモデルがどのスキーマバージョンのデータで学習されたか」を追跡できるようにしておく必要があります。

スキーマ進化に起因する問題としてよくあるのは、

- 新しいラベルカテゴリや属性を追加した結果、古いデータとの統計比較が難しくなる。
- センサー構成変更に伴うフィールド追加・削除により、古いデータを新しいコードで処理しようとするとエラーが発生する。

といったものです。これを防ぐために、

- できる限り「追加は許すが削除・型変更は慎重に」という方針でスキーマを進化させる。
- どうしても非互換な変更が必要な場合には、新旧スキーマを共存させ、変換レイヤで吸収する。

といった運用を行います。データ中心・Closed-Loop の観点では、スキーマ変更時には必ず「既存モデル・評価結果との比較可能性」が損なわれないかを検討し、必要であれば旧スキーマに基づく評価を継続できるようにすることが重要です。

